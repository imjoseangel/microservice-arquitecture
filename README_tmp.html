<!DOCTYPE html>
<html>
<head>
<title>README.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="microservices---design-document">Microservices - Design Document</h1>
<h2 id="license">License</h2>
<p>The content of this project itself is licensed under the Creative Commons Attribution 3.0 Unported license, and the underlying source code used to format and display that content is licensed under the MIT license.</p>
<h2 id="table-of-contents">Table of Contents</h2>
<ul>
<li><a href="#microservices---design-document">Microservices - Design Document</a>
<ul>
<li><a href="#license">License</a></li>
<li><a href="#table-of-contents">Table of Contents</a></li>
<li><a href="#1-introduction">1. Introduction</a>
<ul>
<li><a href="#11-purpose-of-the-system-design-document-sdd">1.1 Purpose of the System Design Document (SDD)</a></li>
<li><a href="#12-audience">1.2 Audience</a></li>
<li><a href="#13-background">1.3 Background</a></li>
<li><a href="#14-problem-statement">1.4 Problem statement</a></li>
<li><a href="#15-strategic-objectives">1.5 Strategic Objectives</a>
<ul>
<li><a href="#table-1-objectives">Table 1: Objectives</a></li>
</ul>
</li>
<li><a href="#16-project-topics">1.6 Project Topics</a>
<ul>
<li><a href="#161-required">1.6.1 Required</a></li>
</ul>
</li>
<li><a href="#17-related-projects">1.7 Related Projects</a></li>
<li><a href="#18-design-constraints">1.8 Design Constraints</a>
<ul>
<li><a href="#institutional">Institutional</a></li>
<li><a href="#technical">Technical</a></li>
<li><a href="#financial">Financial</a></li>
</ul>
</li>
<li><a href="#19-future-contingencies">1.9 Future Contingencies</a></li>
</ul>
</li>
<li><a href="#2-design-guidelines">2. Design Guidelines</a>
<ul>
<li><a href="#21-stakeholder-rolesresponsibilitiesconcerns">2.1 Stakeholder Roles/Responsibilities/Concerns</a>
<ul>
<li><a href="#211-technical--project-stakeholders">2.1.1 Technical / Project Stakeholders</a>
<ul>
<li><a href="#table-2-project-members-contact-information">Table 2: Project members contact information</a></li>
</ul>
</li>
<li><a href="#212-roles">2.1.2 Roles</a></li>
<li><a href="#213-responsibilities">2.1.3 Responsibilities</a></li>
<li><a href="#214-concerns">2.1.4 Concerns</a></li>
</ul>
</li>
<li><a href="#22-design-considerations">2.2 Design Considerations</a>
<ul>
<li><a href="#221-assumptions">2.2.1 Assumptions</a></li>
<li><a href="#222-constraints">2.2.2 Constraints</a></li>
<li><a href="#223-dependencies">2.2.3 Dependencies</a></li>
<li><a href="#224-risks">2.2.4 Risks</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#3-architecture">3. Architecture</a>
<ul>
<li><a href="#31-high-level-flow-diagrams">3.1 High Level Flow Diagrams</a>
<ul>
<li><a href="#components-view">Components View</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#32-sections">3.2 Sections</a>
<ul>
<li><a href="#321-section-1-github-and-code-organization">3.2.1 Section <em>1</em>. GitHub and Code Organization</a></li>
<li><a href="#3211-important-files-and-directories">3.2.1.1 Important files and directories</a>
<ul>
<li><a href="#32111-devcontainer-directory">3.2.1.1.1 <code>.devcontainer</code> directory</a></li>
<li><a href="#32112-editorconfig">3.2.1.1.2 <code>.editorconfig</code></a></li>
<li><a href="#32113-gitattributes">3.2.1.1.3 <code>.gitattributes</code></a></li>
<li><a href="#32114-gitignore">3.2.1.1.4 <code>.gitignore</code></a></li>
<li><a href="#32115-pre-commit-configyaml">3.2.1.1.5 <code>.pre-commit-config.yaml</code></a></li>
<li><a href="#32116-github-directory">3.2.1.1.6 <code>.github</code> directory</a></li>
</ul>
</li>
<li><a href="#3212-branching-strategy">3.2.1.2 Branching Strategy</a></li>
<li><a href="#3213-infrastructure-automation---terraform-and-ansible-git-structure">3.2.1.3 Infrastructure Automation - Terraform and Ansible Git Structure</a>
<ul>
<li><a href="#envs-repository">Envs repository</a></li>
<li><a href="#modules-repository">Modules Repository</a></li>
<li><a href="#envs-and-playbooks-repository">Envs and Playbooks repository</a></li>
</ul>
</li>
<li><a href="#roles-repository">Roles repository</a></li>
<li><a href="#3214-compliance-as-code---chef-git-structure">3.2.1.4 Compliance as Code - Chef Git Structure</a></li>
<li><a href="#3215-python-go-ruby-and-shell-scripting">3.2.1.5 Python, Go, Ruby and Shell scripting</a></li>
<li><a href="#322-section-2-platform-automation">3.2.2 Section <em>2</em>. Platform automation</a>
<ul>
<li><a href="#3221-terraform-and-ansible">3.2.2.1 Terraform and Ansible</a></li>
<li><a href="#32211-a-tool-for-a-specific-purpose">3.2.2.1.1 A tool for a specific purpose</a></li>
<li><a href="#3222-terraform-how-to-deploy-the-solution">3.2.2.2 Terraform. How to deploy the solution</a>
<ul>
<li><a href="#32221-sensitive-variables-export">3.2.2.2.1 Sensitive Variables export</a></li>
<li><a href="#32222-backend-configuration">3.2.2.2.2 Backend Configuration</a></li>
<li><a href="#32223-project-creation">3.2.2.2.3 Project Creation</a></li>
<li><a href="#32224-gke-deployment">3.2.2.2.4 GKE Deployment</a></li>
<li><a href="#32225-connectivity">3.2.2.2.5 Connectivity</a></li>
<li><a href="#32226-zone-redundancy">3.2.2.2.6 Zone redundancy</a></li>
</ul>
</li>
<li><a href="#3223-terraform-versioned-modules">3.2.2.3 Terraform. Versioned modules</a></li>
<li><a href="#3224-other-services">3.2.2.4 Other Services</a></li>
<li><a href="#3225-section-_2b_ansible-kubernetes-operators-microservices-deployment">3.2.2.5 Section _2b_Ansible. Kubernetes Operators. Microservices Deployment</a></li>
</ul>
</li>
<li><a href="#323-section-3-testing">3.2.3 Section <em>3</em>. Testing</a></li>
<li><a href="#3231-pre-commit">3.2.3.1 Pre-Commit</a></li>
<li><a href="#3232-code-testing-and-integration-tests-on-ci">3.2.3.2 Code Testing and Integration Tests on CI</a></li>
<li><a href="#3233-performance-testing">3.2.3.3 Performance Testing</a></li>
<li><a href="#32331-operator-sdk-testing">3.2.3.3.1 Operator SDK Testing</a></li>
<li><a href="#32332-jmeter-testing-and-api-mocking">3.2.3.3.2 JMeter Testing and API Mocking</a></li>
<li><a href="#3234-resilience-testing">3.2.3.4 Resilience Testing</a></li>
<li><a href="#324-section-4a-code-and-cicd-security">3.2.4 Section <em>4a</em>. Code and CI/CD Security</a>
<ul>
<li><a href="#3241-code-security---sast-sca-and-cva">3.2.4.1 Code Security - SAST, SCA and CVA</a></li>
<li><a href="#3242-compliance-as-code">3.2.4.2 Compliance as Code</a></li>
</ul>
</li>
<li><a href="#325-section-4b-passwords-and-certificates-security">3.2.5 Section <em>4b</em>. Passwords and Certificates Security</a></li>
<li><a href="#326-section-4c-waf-and-security-audit---armor">3.2.6 Section <em>4c</em>. WAF and Security Audit - Armor</a></li>
<li><a href="#327-section-5-continuous-integration-and-deployment">3.2.7 Section <em>5</em>. Continuous Integration and Deployment</a></li>
<li><a href="#328-section-6-logging-metrics-and-traceability">3.2.8 Section <em>6</em>. Logging, Metrics and Traceability</a></li>
<li><a href="#3281-google-cloud-operations-stackdriver">3.2.8.1 Google Cloud Operations (Stackdriver)</a>
<ul>
<li><a href="#32811-log-definition-and-best-practices">3.2.8.1.1 Log Definition and Best Practices</a></li>
<li><a href="#3282-k8s-health-checks-and-metrics">3.2.8.2 K8S Health Checks and Metrics</a></li>
</ul>
</li>
<li><a href="#329-section-7-event-driven-autoscaling---keda">3.2.9 Section <em>7</em>. Event-Driven autoscaling - KEDA</a>
<ul>
<li><a href="#3291-kubernetes-cluster-autoscaling">3.2.9.1 Kubernetes Cluster Autoscaling</a></li>
</ul>
</li>
<li><a href="#3210-section-8-microservices-fault-tolerance---istio">3.2.10 Section <em>8</em>. Microservices Fault Tolerance - Istio</a></li>
<li><a href="#3211-section-9-database-and-storage-high-availability">3.2.11 Section <em>9</em>. Database and Storage High availability</a>
<ul>
<li><a href="#32111-backups">3.2.11.1 Backups</a></li>
<li><a href="#32112-multicloud">3.2.11.2 Multicloud</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#4-conclusion">4. Conclusion</a></li>
<li><a href="#5-project-strategy">5. Project Strategy</a>
<ul>
<li><a href="#51-key-milestones-and-deliverables">5.1 Key Milestones and Deliverables</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="1-introduction">1. Introduction</h2>
<p><strong>Project Name:</strong> Microservice Architecture</p>
<p><strong>Project Sponsor/Executive:</strong> Jose Angel Munoz</p>
<h3 id="11-purpose-of-the-system-design-document-sdd">1.1 Purpose of the System Design Document (SDD)</h3>
<p>The SDD documents and tracks the necessary information required to effectively define architecture and system design in order to give the development team guidance on the architecture of the system to be developed. Design documents are incrementally and iteratively produced during the system development life cycle, based on the particular circumstances of the information technology (IT) project and the system development methodology used for developing the system.</p>
<h3 id="12-audience">1.2 Audience</h3>
<p>The intended audience for the SDD is the project manager, project team, and the future development team. The audience or users for this system design document include the following:</p>
<ul>
<li>Project Sponsor</li>
<li>Platform Lead</li>
<li>Platform Development and Operations Team</li>
</ul>
<h3 id="13-background">1.3 Background</h3>
<p>The key principle of microservices is simplicity. Microservices is an approach to developing a single application as a suite of small services, each running in its own process and communicating with lightweight mechanisms, often an HTTP resource API. These services are built around business capabilities and independently deployable by fully automated deployment machinery. There is a bare minimum of centralized management of these services, which may be written in different programming languages and use different data storage technologies.</p>
<h3 id="14-problem-statement">1.4 Problem statement</h3>
<p>Monolithic architectures means the code’s components are designed to work together, as one cohesive unit, sharing the same memory space. The software built using a monolith approach is self-contained; its components are interconnected and interdependent. If developers want to make any changes or updates to a monolith system, they need to build and deploy the entire stack at once. It’s the same thing with scalability: the entire system, not just the modules in it, is scaled together. With the monolithic architecture it can be difficult to adopt a new technology stack, and in case you want to use a new platform or framework, you’ll have to rewrite the entire solution.</p>
<h3 id="15-strategic-objectives">1.5 Strategic Objectives</h3>
<p>The most important objective is to define an architecture based on processes and not tools. When selecting specific tools, we need to keep in mind the possibility to migrate/change if the maintenance or learning curve is too high. It is important to stick in the KISS and Everything as Code minds. The microservices arquitecture objectives are:</p>
<ul>
<li>Allow a system to be divided into a number of smaller, individual and independent services.</li>
<li>Each service is flexible, robust, composable and complete.</li>
<li>They run as autonomous processes and communicate with one another through APIs.</li>
<li>Each microservice can be implemented in a different programming language on a different platform.</li>
<li>Almost any infrastructure can run in a container which holds services encapsulated for operation.</li>
<li>Since these containers can be operated in parallel, the existing infrastructure is easier to maintain.</li>
</ul>
<h4 id="table-1-objectives">Table 1: Objectives</h4>
<p>You have to implement a microservices architecture with the following requirements:</p>
<table>
<thead>
<tr>
<th>Strategic Objectives</th>
<th>Measure</th>
</tr>
</thead>
<tbody>
<tr>
<td>Quality Gates Creation</td>
<td>Define Pre-Commit Linters</td>
</tr>
<tr>
<td>Continuous Integration Quality Gates</td>
<td>Define Quality Gates on CI</td>
</tr>
<tr>
<td>Continuous Integration Security</td>
<td>Define Security on CI</td>
</tr>
<tr>
<td>Integration Tests</td>
<td>Define Integration Tests</td>
</tr>
<tr>
<td>Deploy and Configure Infrastructure</td>
<td>Implement IAC on CI/CD</td>
</tr>
<tr>
<td>Autoscaling</td>
<td>Implement Event Managed for POD and Cluster Autoscaling</td>
</tr>
<tr>
<td>Container Security</td>
<td>Define and Implement Container Security</td>
</tr>
<tr>
<td>Infrastructure Security</td>
<td>Define Compliance as Code</td>
</tr>
<tr>
<td>Monitoring</td>
<td>Define the best monitoring approach for Infra and Apps</td>
</tr>
<tr>
<td>Certificates and Passwords</td>
<td>Define how to implement password and cert security</td>
</tr>
<tr>
<td>Data Store</td>
<td>Add Relational and not relational Data Store</td>
</tr>
<tr>
<td>Logging</td>
<td>Define central logging and rules</td>
</tr>
<tr>
<td>Fault Tolerance</td>
<td>Add Istio for Fault Tolerance</td>
</tr>
<tr>
<td>Multi-zone</td>
<td>Define Multi-zone for Distributed Content and Redundancy</td>
</tr>
<tr>
<td>Environments</td>
<td>Define how to work with different environments</td>
</tr>
<tr>
<td>Upgrade Process</td>
<td>How to upgrade - Operators</td>
</tr>
</tbody>
</table>
<h3 id="16-project-topics">1.6 Project Topics</h3>
<ol>
<li>Git as code repository</li>
<li>Code Quality Security</li>
<li>Continuous Integration and Deployment</li>
<li>Integration Tests</li>
<li>Compliance as Code (Post Deployment)</li>
<li>Infrastructure Automation</li>
<li>Keda for Autoscaling</li>
<li>Container Security</li>
<li>Monitoring and Performance</li>
<li>Password Security and HTTPS certificates with Vault</li>
<li>Relational SQL and NoSQL for data store</li>
<li>Logging</li>
<li>Istio for Fault Tolerance</li>
<li>Cloud Multi-zone redundancy</li>
<li>Environment Definition</li>
<li>Upgrade Processes</li>
</ol>
<h4 id="161-required">1.6.1 Required</h4>
<ol>
<li>Select a Infrastructure Cloud platform</li>
<li>Select orchestration technology</li>
<li>Define the solution to automate the infrastructure deployment</li>
<li>Define the solution to automate the microservices deployment</li>
<li>Define the testing approach for the infrastructure</li>
<li>Define the monitoring approach for the solution</li>
</ol>
<h3 id="17-related-projects">1.7 Related Projects</h3>
<p>There are no related projects attached to this document. This is an independent project.</p>
<h3 id="18-design-constraints">1.8 Design Constraints</h3>
<h4 id="institutional">Institutional</h4>
<p>The proposed solution will be discussed and improved by all the Teams. Coordination and collaboration is always required.</p>
<h4 id="technical">Technical</h4>
<p>The proposed solution intends to standardize all the lines in the Platform and will be the base to prepare the right tools to improve it in the future. There are different subjects that needs to be managed properly during the lifetime of the Project and are a <strong>MUST</strong> to maintain the Quality and Structure of the Platform:</p>
<ul>
<li>Review if Windows support is needed.</li>
<li>Best Practices Documentation.</li>
<li>Clear Understanding about The Team Way of Working.</li>
<li>Design Documentation Approvals before starting the implementation.</li>
</ul>
<h4 id="financial">Financial</h4>
<p>There will be different proposals to adjust the solution PAAS vs IAAS custom solutions. It is important to review how the different technologies can be scaled out or switched off to save costs.</p>
<h3 id="19-future-contingencies">1.9 Future Contingencies</h3>
<p>We have different dependencies for this project and some are critical to the security the Framework, defined under the <a href="#4-conclusion">Conclusion Section</a>.</p>
<ul>
<li>Oauth and RBAC Definition and implementation</li>
<li>POD and Container Security Definition</li>
<li>API Gateway Definition</li>
<li>Networking Definition</li>
<li>Cache Management</li>
<li>Self-Service for Infrastructure</li>
<li>Cost Management</li>
</ul>
<h2 id="2-design-guidelines">2. Design Guidelines</h2>
<h3 id="21-stakeholder-rolesresponsibilitiesconcerns">2.1 Stakeholder Roles/Responsibilities/Concerns</h3>
<p>System design can cross many different groups within an organization to ensure requirements are gathered and met for all stakeholders. As such, the roles and responsibilities section may be necessary to provide the team with clarification on who performs various roles. This section also serves as a list of points of contact for the team and stakeholders should issues and concerns arise which need to be addressed.</p>
<h4 id="211-technical--project-stakeholders">2.1.1 Technical / Project Stakeholders</h4>
<p>The following table provides the role and contact information for the key technical and project stakeholders associated with the system design.</p>
<h5 id="table-2-project-members-contact-information">Table 2: Project members contact information</h5>
<table>
<thead>
<tr>
<th>Name</th>
<th>Role</th>
<th>email</th>
</tr>
</thead>
<tbody>
<tr>
<td>Jose Angel Munoz</td>
<td>Executive Sponsor</td>
<td>josea.munoz@gmail.com</td>
</tr>
</tbody>
</table>
<h4 id="212-roles">2.1.2 Roles</h4>
<ul>
<li>
<p><strong>Executive Sponsor</strong>:</p>
<ol>
<li><em>Approver and Sponsor</em> of the Solution as they will follow and approve the Solution Implementation.</li>
</ol>
</li>
<li>
<p><strong>IAC Lead</strong>:</p>
<ol>
<li><em>Managers</em> of the Solution as they will conduct next steps and act as referees</li>
</ol>
</li>
<li>
<p><strong>IAC Developers</strong>:</p>
<ol>
<li><em>Reviewers</em> of the Solution as they review code of the platform itself and ensure the quality of the solution.</li>
</ol>
</li>
</ul>
<h4 id="213-responsibilities">2.1.3 Responsibilities</h4>
<ul>
<li>
<p><strong>IAC Lead</strong>:</p>
<ol>
<li>Review Document</li>
</ol>
</li>
<li>
<p><strong>IAC Developer</strong>:</p>
<ol>
<li>Review Document</li>
</ol>
</li>
</ul>
<h4 id="214-concerns">2.1.4 Concerns</h4>
<p>The solution will cover the most important topics and will be focused on <strong>GCP</strong> as the default Cloud provider.</p>
<h3 id="22-design-considerations">2.2 Design Considerations</h3>
<h4 id="221-assumptions">2.2.1 Assumptions</h4>
<ol>
<li>Use Git for code repository with <strong>GitHub</strong> as provider.</li>
<li>Use of <strong>Terraform</strong> for infrastructure deployment as the default and <strong>Ansible</strong> for orchestration, configuration and K8s Operators.</li>
<li>Use of <strong>Bash</strong>, <strong>Python</strong>, <strong>Ruby</strong> and <strong>Go</strong> as coding languages.</li>
<li>Use of VSCode as default IDE.</li>
</ol>
<h4 id="222-constraints">2.2.2 Constraints</h4>
<p>No constraints have been detected so far.</p>
<h4 id="223-dependencies">2.2.3 Dependencies</h4>
<p>The current implementation is dependent on the following technologies and providers among others:</p>
<ul>
<li>Google Cloud Platform</li>
<li>GitHub</li>
<li>Pre-Commit</li>
<li>Kubernetes (GKS)</li>
<li>Terraform</li>
<li>Vault</li>
<li>Ansible and Molecule</li>
<li>Chef</li>
<li>JMeter</li>
<li>Keda</li>
<li>Istio</li>
<li>Prometheus</li>
<li>ELK</li>
<li>Grafana</li>
</ul>
<h4 id="224-risks">2.2.4 Risks</h4>
<p>Minimal risk is associated with the system design. This is primarily due to the fact that the current and architecture will not be modified to meet the needs of the proposed solution. New features and solutions can be implemented without breaking current implementations.</p>
<p>Properly Alignment with the the teams (Two-Way KT and Support) and splitting the project in phases are key for its implementation.</p>
<h2 id="3-architecture">3. Architecture</h2>
<h3 id="31-high-level-flow-diagrams">3.1 High Level Flow Diagrams</h3>
<h4 id="components-view">Components View</h4>
<p><img src="file:///Users/imjoseangel/Documents/source/imjoseangel/microservice-arquitecture/microservices_architecture.png" alt="Microservices Architecture"></p>
<h2 id="32-sections">3.2 Sections</h2>
<h3 id="321-section-1-github-and-code-organization">3.2.1 Section <em>1</em>. GitHub and Code Organization</h3>
<p>In the Section 1, we will define a standard repository for most programming languages. The idea is implementing good practices and cover most of the scenarios.</p>
<h3 id="3211-important-files-and-directories">3.2.1.1 Important files and directories</h3>
<h4 id="32111-devcontainer-directory">3.2.1.1.1 <code>.devcontainer</code> directory</h4>
<p><code>.devcontainer</code> will contain a default configuration to use with VSCode Remote-Containers Plugin. This is a way to have a controlled scenario for local testing. It has the following structure:</p>
<pre class="hljs"><code><div>.devcontainer/
├── Dockerfile
├── README.md
└── devcontainer.json
scripts/
└── common-debian.sh
</div></code></pre>
<p>The <code>devcontainer.json</code> has the configuration for VSCode. For instance the extensions and default settings:</p>
<pre class="hljs"><code><div><span class="hljs-comment">// Set *default* container specific settings.json values on container create.</span>
<span class="hljs-string">"settings"</span>: {
    <span class="hljs-attr">"terminal.integrated.shell.linux"</span>: <span class="hljs-string">"/bin/bash"</span>,
    <span class="hljs-attr">"python.pythonPath"</span>: <span class="hljs-string">"/usr/local/bin/python"</span>,
    <span class="hljs-attr">"python.linting.enabled"</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">"python.linting.pylintEnabled"</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">"python.linting.banditPath"</span>: <span class="hljs-string">"/usr/local/py-utils/bin/bandit"</span>,
    <span class="hljs-attr">"python.linting.pylintPath"</span>: <span class="hljs-string">"/usr/local/py-utils/bin/pylint"</span>,
    <span class="hljs-attr">"python.testing.pytestPath"</span>: <span class="hljs-string">"/usr/local/py-utils/bin/pytest"</span>
},
<span class="hljs-comment">// Add the IDs of extensions you want installed when the container is created.</span>
<span class="hljs-string">"extensions"</span>: [
    <span class="hljs-string">"ms-python.python"</span>,
    <span class="hljs-string">"vscoss.vscode-ansible"</span>,
    <span class="hljs-string">"redhat.vscode-yaml"</span>,
    <span class="hljs-string">"ms-vscode.azurecli"</span>,
    <span class="hljs-string">"ms-azuretools.vscode-docker"</span>
],
</div></code></pre>
<p>The <code>Dockerfile</code> will be used to build the container with all the specific tools for the development. It uses the <code>common-debian.sh</code> script to build it. More information. More info at <a href="https://github.com/microsoft/vscode-dev-containers">VS Code Remote Development GitHub</a>.</p>
<h4 id="32112-editorconfig">3.2.1.1.2 <code>.editorconfig</code></h4>
<p>The <a href="http://EditorConfig.org">editorconfig</a> helps developers define and maintain consistent coding styles between different editors and IDEs</p>
<pre class="hljs"><code><div><span class="hljs-comment"># top-most EditorConfig file</span>
<span class="hljs-attr">root</span> = <span class="hljs-literal">true</span>

<span class="hljs-comment"># Unix-style newlines with a newline ending every file</span>
<span class="hljs-section">[ ]</span>
<span class="hljs-attr">charset</span> = utf-<span class="hljs-number">8</span>
<span class="hljs-attr">end_of_line</span> = lf
<span class="hljs-attr">insert_final_newline</span> = <span class="hljs-literal">true</span>
<span class="hljs-attr">trim_trailing_whitespace</span> = <span class="hljs-literal">true</span>

<span class="hljs-section">[*.{py,rst,ini}]</span>
<span class="hljs-attr">indent_style</span> = space
<span class="hljs-attr">indent_size</span> = <span class="hljs-number">4</span>

<span class="hljs-section">[*.{yml,yaml}]</span>
<span class="hljs-attr">indent_style</span> = space
<span class="hljs-attr">indent_size</span> = <span class="hljs-number">2</span>
</div></code></pre>
<h4 id="32113-gitattributes">3.2.1.1.3 <code>.gitattributes</code></h4>
<p>Automatically normalize line endings for all text-based files</p>
<pre class="hljs"><code><div>* text=auto eol=lf
* whitespace=space-before-tab,tab-in-indent,trailing-space,tab
*.{cmd,<span class="hljs-section">[cC]</span><span class="hljs-section">[mM]</span><span class="hljs-section">[dD]</span>} text eol=crlf
*.{bat,<span class="hljs-section">[bB]</span><span class="hljs-section">[aA]</span><span class="hljs-section">[tT]</span>} text eol=crlf
*.{py} text eol=lf diff=python


.gitattributes export-ignore
.gitignore export-ignore
.gitmodules export-ignore
</div></code></pre>
<h4 id="32114-gitignore">3.2.1.1.4 <code>.gitignore</code></h4>
<p>A <code>.gitignore</code> file specifies intentionally untracked files that Git should ignore.</p>
<pre class="hljs"><code><div><span class="hljs-comment">### Sandbox: anything in that directory will be ignored</span>
sandbox/
secrets/
.vscode/

.vagrant
*/packer_cache/*
*/packer_iso/*

.pe_build
*.dpkg-dist
*.rpmnew
</div></code></pre>
<h4 id="32115-pre-commit-configyaml">3.2.1.1.5 <code>.pre-commit-config.yaml</code></h4>
<p>The <a href="https://pre-commit.com/">pre-commit</a> config file describes what repositories and hooks are installed for pre-commit. This file is located in the root of every project and as noticed is a YAML file with the different tasks to run.</p>
<p>We will use this tool for static code analysis and other utilities that will run before committing code to the repo. All these functionalities added to pre-commit will be reused in the CI process.</p>
<h4 id="32116-github-directory">3.2.1.1.6 <code>.github</code> directory</h4>
<p>It contains all the GitHub templates and document to standardize the project. Adding this structure as a project in the GitHub Organization will affect all the projects.</p>
<pre class="hljs"><code><div>.github/
├── CODE_OF_CONDUCT.md
├── CONTRIBUTING.md
├── ISSUE_TEMPLATE
│   ├── bug_report.md
│   ├── config.yml
│   ├── documentation_report.md
│   └── feature_request.md
├── ISSUE_TEMPLATE.md
└── PULL_REQUEST_TEMPLATE.md
</div></code></pre>
<p>An example of every file can be found at <a href="https://github.com/imjoseangel/open-source-contribution/tree/devel/.github">GitHub</a>.</p>
<h3 id="3212-branching-strategy">3.2.1.2 Branching Strategy</h3>
<p>To improve team collaboration, quality and fast deployments, the best Branching strategy is <em>Trunk Based Development</em> or <em>GitHub Flow</em> (Don't confuse with <em>Git Flow</em>) alternative that adds different mechanism to the release process but keeps the soul of the <em>Trunk Based</em>.</p>
<p>Besides all the advantages from the <em>Trunk Based</em>, the <em>GitHub Flow</em> will help developers to understand and collaborate more actively with Open Source and learn techniques to apply to the platform.</p>
<h3 id="3213-infrastructure-automation---terraform-and-ansible-git-structure">3.2.1.3 Infrastructure Automation - Terraform and Ansible Git Structure</h3>
<p>When creating infrastructure as code, there are different aspects to take into account:</p>
<ul>
<li>Code Maintainability and Reusable</li>
<li>Deployment Speed and Reliability</li>
<li>Idempotency</li>
<li>Testing</li>
<li>Self-Service</li>
</ul>
<p>We have chose Ansible for Configuration Management and Terraform for Provisioning. It is important to make the most of both tools to achieve the points defined above.</p>
<p>The recommendation is keeping the following structure for <strong>Terraform</strong>, using reusable modules and specific environments:</p>
<h4 id="envs-repository">Envs repository</h4>
<pre class="hljs"><code><div>.
└── envs
    ├── prod
    │   └── services
    │       └── gke-cluster
    │           ├── main.tf
    │           ├── outputs.tf
    │           └── vars.tf
    └── dev
        └── services
            └── gke-cluster
                ├── main.tf
                ├── outputs.tf
                └── vars.tf
</div></code></pre>
<h4 id="modules-repository">Modules Repository</h4>
<pre class="hljs"><code><div>.
└── modules
    └── services
        └── gke-cluster
            ├── main.tf
            ├── outputs.tf
            └── vars.tf
</div></code></pre>
<p>Where the environment reads the module and the release (Tagged as v20200825):</p>
<pre class="hljs"><code><div><span class="hljs-string">module</span> <span class="hljs-string">"gke"</span> <span class="hljs-string">{</span>
  <span class="hljs-string">source</span>     <span class="hljs-string">=</span> <span class="hljs-string">"github.com/imjoseangel/modules/services/gke-cluster?ref=v20200825"</span>
  <span class="hljs-string">project_id</span> <span class="hljs-string">=</span> <span class="hljs-string">var.project_id</span>
  <span class="hljs-string">name</span>       <span class="hljs-string">=</span> <span class="hljs-string">"${local.cluster_type}-cluster${var.cluster_name_suffix}"</span>
  <span class="hljs-string">region</span>     <span class="hljs-string">=</span> <span class="hljs-string">var.region</span>
  <span class="hljs-string">network</span>    <span class="hljs-string">=</span> <span class="hljs-string">var.network</span>
  <span class="hljs-string">subnetwork</span> <span class="hljs-string">=</span> <span class="hljs-string">var.subnetwork</span>

  <span class="hljs-string">ip_range_pods</span>          <span class="hljs-string">=</span> <span class="hljs-string">var.ip_range_pods</span>
  <span class="hljs-string">ip_range_services</span>      <span class="hljs-string">=</span> <span class="hljs-string">var.ip_range_services</span>
  <span class="hljs-string">create_service_account</span> <span class="hljs-string">=</span> <span class="hljs-literal">false</span>
  <span class="hljs-string">service_account</span>        <span class="hljs-string">=</span> <span class="hljs-string">var.compute_engine_service_account</span>
<span class="hljs-string">}</span>
</div></code></pre>
<p>For <strong>Ansible</strong> the recommendation is mostly the same:</p>
<p>Keep reusable roles with specific environments:</p>
<h4 id="envs-and-playbooks-repository">Envs and Playbooks repository</h4>
<pre class="hljs"><code><div>.
├── inventories
│   └── <span class="hljs-built_in">local</span>
│       └── hosts
├── playbooks
│   └── gke
│       ├── main.yml
│       └── pretasks.yml
├── roles
│   ├── gke-cluster
│   │   ├── README.md
│   │   ├── defaults
│   │   │   └── main.yml
│   │   ├── files
│   │   │   └── hostsfile
│   │   ├── handlers
│   │   │   └── main.yml
│   │   ├── meta
│   │   │   └── main.yml
│   │   ├── tasks
│   │   │   ├── create.yml
│   │   │   ├── delete.yml
│   │   │   └── main.yml
│   │   └── vars
│   │       └── main.yml
│   └── requirements.yml
└── vars
    ├── prod
    │   └── common.ym
    └── dev
        └── common.yml
</div></code></pre>
<h3 id="roles-repository">Roles repository</h3>
<p>A repository is needed with the following structure:</p>
<pre class="hljs"><code><div>.
├── meta
│   └── main.yml
├── role1
├── role2
└── role*N*
</div></code></pre>
<h3 id="3214-compliance-as-code---chef-git-structure">3.2.1.4 Compliance as Code - Chef Git Structure</h3>
<p>Simple, the recommendation is to keep the structure given by <a href="https://github.com/dev-sec">dev-sec</a>. For internal developments, we should keep the same.</p>
<p>We can keep different environments, but initially better to have a common one.</p>
<pre class="hljs"><code><div>.
├── Gemfile
├── Rakefile
├── controls
│   ├── control1_spec.rb
│   ├── control2_spec.rb
│   └── control*N*_spec.rb
├── inspec.yml
└── libraries
    ├── library1.rb
    ├── library2.rb
    └── library*N*.rb
</div></code></pre>
<h3 id="3215-python-go-ruby-and-shell-scripting">3.2.1.5 Python, Go, Ruby and Shell scripting</h3>
<p>The recommendation is to keep as much consistency as possible and keep every tool with their code base to have clear testing processes and avoid long testing processes. Also it is important to have a collaboration mind and maintain the community with fixes directly to the main projects (Terraform, Ansible, Dev-Sec, etc).</p>
<ul>
<li>Terraform -&gt; Go</li>
<li>Ansible -&gt; Python</li>
<li>Chef and Inspec -&gt; Ruby</li>
</ul>
<p>Using Python as default will give us the possibility to use tools like pre-commit. Also python is by default in all the *nix Systems, so it it easier to run. Programming small scripts in bash when needed is perfect (Docker entrypoints, pre-commit hooks, etc), but we need to be sure that is compatible with other shells like <code>zsh</code> or <code>ksh</code>.</p>
<p>If needed remember that Powershell is also an option and mostly when talking about Windows environments.</p>
<h3 id="322-section-2-platform-automation">3.2.2 Section <em>2</em>. Platform automation</h3>
<h4 id="3221-terraform-and-ansible">3.2.2.1 Terraform and Ansible</h4>
<p>When talking about cloud, there is a difference between Terraform and Ansible at the time of deploy a service. <em>Terraforn</em> has a declarative style that specified the desired end state. Ansible can usually do both procedural and declarative, but the learning curve to implement this last option is medium to high.</p>
<p>When working with Terraform, we need to be careful to not remove already created component when changing a bit of code.</p>
<p>For instance if we want to install a GKE we can do:</p>
<pre class="hljs"><code><div><span class="hljs-string">resource</span> <span class="hljs-string">"google_container_cluster"</span> <span class="hljs-string">"primary"</span> <span class="hljs-string">{</span>

  <span class="hljs-string">name</span>     <span class="hljs-string">=</span> <span class="hljs-string">"my-gke-cluster"</span>
  <span class="hljs-string">location</span> <span class="hljs-string">=</span> <span class="hljs-string">"us-central1"</span>
<span class="hljs-string">...</span>
<span class="hljs-string">}</span>
</div></code></pre>
<p>That will install a single GKE.</p>
<p>But if we change to:</p>
<pre class="hljs"><code><div><span class="hljs-string">resource</span> <span class="hljs-string">"google_container_cluster"</span> <span class="hljs-string">"primary"</span> <span class="hljs-string">{</span>
  <span class="hljs-string">count</span>    <span class="hljs-string">=</span> <span class="hljs-string">length(var.k8s_names)</span>
  <span class="hljs-string">name</span>     <span class="hljs-string">=</span> <span class="hljs-string">"${var.k8s_names[count.index]}-gke"</span>
  <span class="hljs-string">location</span> <span class="hljs-string">=</span> <span class="hljs-string">"us-central1"</span>
<span class="hljs-string">...</span>
<span class="hljs-string">}</span>
</div></code></pre>
<p>Where vars is</p>
<pre class="hljs"><code><div><span class="hljs-string">variable</span> <span class="hljs-string">"k8s_names"</span> <span class="hljs-string">{</span>
  <span class="hljs-string">description</span> <span class="hljs-string">=</span> <span class="hljs-string">"Create AKS with these names"</span>
  <span class="hljs-string">type</span>        <span class="hljs-string">=</span> <span class="hljs-string">list(string)</span>
  <span class="hljs-string">default</span>     <span class="hljs-string">=</span> <span class="hljs-string">["phineas",</span> <span class="hljs-string">"ferb"</span><span class="hljs-string">,</span> <span class="hljs-string">"candace"</span><span class="hljs-string">]</span>
<span class="hljs-string">}</span>
</div></code></pre>
<p>It will destroy <code>my-gke-cluster</code> and create 3 new clusters with the given name.</p>
<p>This scenario is perfect for inmmutable infrastructure and is something not inherent in the Ansible philosophy. That is the flaw point for Ansible, you need to create bunch of code for a simple operation like this.</p>
<p>In the other hand, the flaw point of Terraform is knowing what is already in place. And even removing what was created manually or even in previous processes. Here is where Ansible can help if needed.</p>
<h4 id="32211-a-tool-for-a-specific-purpose">3.2.2.1.1 A tool for a specific purpose</h4>
<p>The important point here is using only one tool for a specific purpose if possible. When finding an issue working with multiple tools is harder to debug it due to the complexity of the solution. The simple, the better.</p>
<p>We choose:</p>
<ul>
<li>Terraform for infrastructure deployment. Learning Curve is low, we can create a good code structure, it can create and destroy in parallel and has a good Cloud support.</li>
<li>Ansible for testing, operator creation and deployment and cleaning. The learning curve for a good architecture is higher but for testing, operators, cleaning processes and even to create status for Terraform is perfect.</li>
</ul>
<h4 id="3222-terraform-how-to-deploy-the-solution">3.2.2.2 Terraform. How to deploy the solution</h4>
<p>The most important part is following the structure defined under <a href="#envs-repository">git rules</a>. Under GCP, we will create one project per environment. If we need to create different isolated applications, we will create a project per application per environment. In this document we assume we have only one application, so we will create two projects.</p>
<blockquote>
<p>Note: All the operations explained below has to be done on CI and with the right security from the beginning. The solution for password management is <strong>Hashicorp Vault</strong></p>
</blockquote>
<p>We assume that the initial service account is already configured to do the deploy with the right permissions and API enabled:</p>
<pre class="hljs"><code><div>cloudresourcemanager.googleapis.com
cloudbilling.googleapis.com
iam.googleapis.com
compute.googleapis.com
serviceusage.googleapis.com
</div></code></pre>
<h5 id="32221-sensitive-variables-export">3.2.2.2.1 Sensitive Variables export</h5>
<p>Export of sensitive information as environment variables is the better choice. As said, this will be done with variables on the CI process.</p>
<pre class="hljs"><code><div>TF_VAR_org_id
TF_VAR_billing_account
TF_ADMIN
TF_CREDS
GOOGLE_APPLICATION_CREDENTIALS=<span class="hljs-variable">${TF_CREDS}</span>
GOOGLE_PROJECT=<span class="hljs-variable">${TF_ADMIN}</span>
</div></code></pre>
<h5 id="32222-backend-configuration">3.2.2.2.2 Backend Configuration</h5>
<p>We assume that a backend for the <code>.tfstate</code> is already created and with Object Versioning enabled: <code>gsutil versioning set on gs://${TF_ADMIN}</code>. This will allow state recovery in case of deletion.</p>
<p>The <code>backend.tf</code> file will be like:</p>
<pre class="hljs"><code><div><span class="hljs-string">terraform</span> <span class="hljs-string">{</span>
 <span class="hljs-string">backend</span> <span class="hljs-string">"gcs"</span> <span class="hljs-string">{</span>
   <span class="hljs-string">bucket</span>  <span class="hljs-string">=</span> <span class="hljs-string">"${TF_ADMIN}"</span>
   <span class="hljs-string">prefix</span>  <span class="hljs-string">=</span> <span class="hljs-string">"terraform/state"</span>
 <span class="hljs-string">}</span>
<span class="hljs-string">}</span>
</div></code></pre>
<p>Do terraform init --backend-config=&quot;encryption_key=SECRET&quot; to encrypt the backend.
The encryption key WILL be written to the .terraform directory. This needs to be managed and store in the <em>Vault</em> solution.</p>
<h5 id="32223-project-creation">3.2.2.2.3 Project Creation</h5>
<blockquote>
<p>Note: From now on, we assume that all the calls are referring as modules with this format:</p>
</blockquote>
<pre class="hljs"><code><div><span class="hljs-string">module</span> <span class="hljs-string">"project"</span> <span class="hljs-string">{</span>
  <span class="hljs-string">source</span>          <span class="hljs-string">=</span> <span class="hljs-string">"github.com/imjoseangel/modules/services/gcp-project?ref=v20200825"</span>
  <span class="hljs-string">project_id</span>      <span class="hljs-string">=</span> <span class="hljs-string">var.project_id</span>
  <span class="hljs-string">name</span>            <span class="hljs-string">=</span> <span class="hljs-string">var.project_name</span>
<span class="hljs-string">}</span>
</div></code></pre>
<p>Where the <code>vars.tf</code> file is:</p>
<pre class="hljs"><code><div><span class="hljs-string">variable</span> <span class="hljs-string">"project_id"</span> <span class="hljs-string">{</span>
  <span class="hljs-string">description</span> <span class="hljs-string">=</span> <span class="hljs-string">"The id of the project"</span>
  <span class="hljs-string">type</span>        <span class="hljs-string">=</span> <span class="hljs-string">string</span>
<span class="hljs-string">}</span>

<span class="hljs-string">variable</span> <span class="hljs-string">"project_name"</span> <span class="hljs-string">{</span>
  <span class="hljs-string">description</span> <span class="hljs-string">=</span> <span class="hljs-string">"The name of the project"</span>
  <span class="hljs-string">type</span>        <span class="hljs-string">=</span> <span class="hljs-string">string</span>
<span class="hljs-string">}</span>
</div></code></pre>
<p>And the module will contain:</p>
<pre class="hljs"><code><div><span class="hljs-string">resource</span> <span class="hljs-string">"google_project"</span> <span class="hljs-string">"project"</span> <span class="hljs-string">{</span>
  <span class="hljs-string">count</span>           <span class="hljs-string">=</span> <span class="hljs-string">length(var.env_names)</span>
  <span class="hljs-string">project_id</span>      <span class="hljs-string">=</span> <span class="hljs-string">"${var.project_id}-${var.env_names[count.index]}
  name            = "</span><span class="hljs-string">${var.project_name}-${var.env_names[count.index]}</span>
  <span class="hljs-string">billing_account</span> <span class="hljs-string">=</span> <span class="hljs-string">var.billing_account</span>
  <span class="hljs-string">org_id</span>          <span class="hljs-string">=</span> <span class="hljs-string">var.org_id</span>
<span class="hljs-string">}</span>
</div></code></pre>
<p>The module variables:</p>
<pre class="hljs"><code><div><span class="hljs-string">variable</span> <span class="hljs-string">"env_names"</span> <span class="hljs-string">{</span>
  <span class="hljs-string">description</span> <span class="hljs-string">=</span> <span class="hljs-string">"Create environments"</span>
  <span class="hljs-string">type</span>        <span class="hljs-string">=</span> <span class="hljs-string">list(string)</span>
  <span class="hljs-string">default</span>     <span class="hljs-string">=</span> <span class="hljs-string">["prod",</span> <span class="hljs-string">"dev"</span><span class="hljs-string">]</span>
<span class="hljs-string">}</span>
</div></code></pre>
<p>Although this is a very simple example, find that the main module is totally inmutable and will define the environments by default.</p>
<h5 id="32224-gke-deployment">3.2.2.2.4 GKE Deployment</h5>
<p>We will take a GKE as deployment example with NGIX Ingress. The rest of the components will follow the same structure. There are different topics that will be covered later as networking or security.</p>
<p>Besides the GKE Creation:</p>
<pre class="hljs"><code><div><span class="hljs-string">resource</span> <span class="hljs-string">"google_container_cluster"</span> <span class="hljs-string">"primary"</span> <span class="hljs-string">{</span>
  <span class="hljs-string">name</span>     <span class="hljs-string">=</span> <span class="hljs-string">"my-gke-cluster"</span>
  <span class="hljs-string">location</span> <span class="hljs-string">=</span> <span class="hljs-string">"us-central1"</span>

  <span class="hljs-string">remove_default_node_pool</span> <span class="hljs-string">=</span> <span class="hljs-literal">true</span>
  <span class="hljs-string">initial_node_count</span>       <span class="hljs-string">=</span> <span class="hljs-number">1</span>
<span class="hljs-string">...</span>
<span class="hljs-string">}</span>

<span class="hljs-string">resource</span> <span class="hljs-string">"google_container_node_pool"</span> <span class="hljs-string">"primary_preemptible_nodes"</span> <span class="hljs-string">{</span>
  <span class="hljs-string">name</span>       <span class="hljs-string">=</span> <span class="hljs-string">"my-node-pool"</span>
  <span class="hljs-string">location</span>   <span class="hljs-string">=</span> <span class="hljs-string">"us-central1"</span>
  <span class="hljs-string">cluster</span>    <span class="hljs-string">=</span> <span class="hljs-string">google_container_cluster.primary.name</span>
  <span class="hljs-string">node_count</span> <span class="hljs-string">=</span> <span class="hljs-number">1</span>

  <span class="hljs-string">node_config</span> <span class="hljs-string">{</span>
    <span class="hljs-string">preemptible</span>  <span class="hljs-string">=</span> <span class="hljs-literal">true</span>
    <span class="hljs-string">machine_type</span> <span class="hljs-string">=</span> <span class="hljs-string">"e2-medium"</span>

    <span class="hljs-string">metadata</span> <span class="hljs-string">=</span> <span class="hljs-string">{</span>
      <span class="hljs-string">disable-legacy-endpoints</span> <span class="hljs-string">=</span> <span class="hljs-string">"true"</span>
    <span class="hljs-string">}</span>

    <span class="hljs-string">oauth_scopes</span> <span class="hljs-string">=</span> <span class="hljs-string">[</span>
      <span class="hljs-string">"https://www.googleapis.com/auth/logging.write"</span><span class="hljs-string">,</span>
      <span class="hljs-string">"https://www.googleapis.com/auth/monitoring"</span><span class="hljs-string">,</span>
    <span class="hljs-string">]</span>

    <span class="hljs-string">tags</span> <span class="hljs-string">=</span> <span class="hljs-string">["mygkenodes"]</span>
  <span class="hljs-string">}</span>
<span class="hljs-string">}</span>
</div></code></pre>
<p>For production, the automation needs to be more advanced, for instance the tags creation defining locals:</p>
<pre class="hljs"><code><div><span class="hljs-string">locals</span> <span class="hljs-string">{</span>
  <span class="hljs-comment"># Common tags to be assigned to all resources</span>
  <span class="hljs-string">common_tags</span> <span class="hljs-string">=</span> <span class="hljs-string">{</span>
    <span class="hljs-string">Service</span> <span class="hljs-string">=</span> <span class="hljs-string">local.service_name</span>
    <span class="hljs-string">Owner</span>   <span class="hljs-string">=</span> <span class="hljs-string">local.owner</span>
  <span class="hljs-string">}</span>
<span class="hljs-string">}</span>
</div></code></pre>
<p>And apply them like:</p>
<pre class="hljs"><code><div><span class="hljs-string">tags</span> <span class="hljs-string">=</span> <span class="hljs-string">local.common_tags</span>
</div></code></pre>
<p>Or a more advanced approach:</p>
<pre class="hljs"><code><div><span class="hljs-string">locals</span> <span class="hljs-string">{</span>
  <span class="hljs-string">node_pools_tags</span> <span class="hljs-string">=</span> <span class="hljs-string">merge(</span>
    <span class="hljs-string">{</span> <span class="hljs-string">all</span> <span class="hljs-string">=</span> <span class="hljs-string">[]</span> <span class="hljs-string">},</span>
    <span class="hljs-string">{</span> <span class="hljs-string">default-node-pool</span> <span class="hljs-string">=</span> <span class="hljs-string">[]</span> <span class="hljs-string">},</span>
    <span class="hljs-string">zipmap(</span>
      <span class="hljs-string">[for</span> <span class="hljs-attr">node_pool in var.node_pools :</span> <span class="hljs-string">node_pool["name"]],</span>
      <span class="hljs-string">[for</span> <span class="hljs-attr">node_pool in var.node_pools :</span> <span class="hljs-string">[</span> <span class="hljs-string">]</span>
    <span class="hljs-string">),</span>
    <span class="hljs-string">var.node_pools_tags</span>
  <span class="hljs-string">)</span>
<span class="hljs-string">}</span>
</div></code></pre>
<pre class="hljs"><code><div><span class="hljs-string">tags</span> <span class="hljs-string">=</span> <span class="hljs-string">concat(</span>
    <span class="hljs-string">lookup(local.node_pools_tags,</span> <span class="hljs-string">"default_values"</span><span class="hljs-string">,</span> <span class="hljs-string">[true,</span> <span class="hljs-literal">true</span><span class="hljs-string">])[</span> <span class="hljs-string">]</span> <span class="hljs-string">?</span> <span class="hljs-string">[local.cluster_network_tag]</span> <span class="hljs-string">:</span> <span class="hljs-string">[],</span>
    <span class="hljs-string">lookup(local.node_pools_tags,</span> <span class="hljs-string">"default_values"</span><span class="hljs-string">,</span> <span class="hljs-string">[true,</span> <span class="hljs-literal">true</span><span class="hljs-string">])[</span> <span class="hljs-string">]</span> <span class="hljs-string">?</span> <span class="hljs-string">["${local.cluster_network_tag}-${each.value["name"]}"]</span> <span class="hljs-string">:</span> <span class="hljs-string">[],</span>
    <span class="hljs-string">local.node_pools_tags["all"],</span>
    <span class="hljs-string">local.node_pools_tags[each.value["name"]],</span>
<span class="hljs-string">)</span>
</div></code></pre>
<p>It is possible to deploy the Ingress with Terraform too:</p>
<pre class="hljs"><code><div><span class="hljs-string">resource</span> <span class="hljs-string">"kubernetes_pod"</span> <span class="hljs-string">"nginx"</span> <span class="hljs-string">{</span>
  <span class="hljs-string">metadata</span> <span class="hljs-string">{</span>
    <span class="hljs-string">name</span> <span class="hljs-string">=</span> <span class="hljs-string">"nginx"</span>

    <span class="hljs-string">labels</span> <span class="hljs-string">=</span> <span class="hljs-string">{</span>
      <span class="hljs-string">maintained_by</span> <span class="hljs-string">=</span> <span class="hljs-string">"terraform"</span>
      <span class="hljs-string">app</span>           <span class="hljs-string">=</span> <span class="hljs-string">"nginx"</span>
    <span class="hljs-string">}</span>
  <span class="hljs-string">}</span>

  <span class="hljs-string">spec</span> <span class="hljs-string">{</span>
    <span class="hljs-string">container</span> <span class="hljs-string">{</span>
      <span class="hljs-string">image</span> <span class="hljs-string">=</span> <span class="hljs-string">"nginx:1.7.9"</span>
      <span class="hljs-string">name</span>  <span class="hljs-string">=</span> <span class="hljs-string">"nginx"</span>
    <span class="hljs-string">}</span>
  <span class="hljs-string">}</span>

  <span class="hljs-string">depends_on</span> <span class="hljs-string">=</span> <span class="hljs-string">[module.gke]</span>
<span class="hljs-string">}</span>
</div></code></pre>
<p>And the LoadBalancer</p>
<pre class="hljs"><code><div><span class="hljs-string">resource</span> <span class="hljs-string">"kubernetes_service"</span> <span class="hljs-string">"nginx"</span> <span class="hljs-string">{</span>
  <span class="hljs-string">metadata</span> <span class="hljs-string">{</span>
    <span class="hljs-string">name</span> <span class="hljs-string">=</span> <span class="hljs-string">"terraform"</span>
  <span class="hljs-string">}</span>

  <span class="hljs-string">spec</span> <span class="hljs-string">{</span>
    <span class="hljs-string">selector</span> <span class="hljs-string">=</span> <span class="hljs-string">{</span>
      <span class="hljs-string">app</span> <span class="hljs-string">=</span> <span class="hljs-string">kubernetes_pod.nginx.metadata[</span> <span class="hljs-string">].labels.app</span>
    <span class="hljs-string">}</span>

    <span class="hljs-string">session_affinity</span> <span class="hljs-string">=</span> <span class="hljs-string">"ClientIP"</span>

    <span class="hljs-string">port</span> <span class="hljs-string">{</span>
      <span class="hljs-string">port</span>        <span class="hljs-string">=</span> <span class="hljs-number">8080</span>
      <span class="hljs-string">target_port</span> <span class="hljs-string">=</span> <span class="hljs-number">80</span>
    <span class="hljs-string">}</span>

    <span class="hljs-string">type</span> <span class="hljs-string">=</span> <span class="hljs-string">"LoadBalancer"</span>
  <span class="hljs-string">}</span>

  <span class="hljs-string">depends_on</span> <span class="hljs-string">=</span> <span class="hljs-string">[module.gke]</span>
<span class="hljs-string">}</span>
</div></code></pre>
<p>Have a look to the <code>depends_on</code> option that will wait and confirm that gke is created already.</p>
<p>One of the most important pieces in this architecture is the Load Balancer. It will maintain the SSL certificates stored in the Vault.</p>
<pre class="hljs"><code><div><span class="hljs-string">resource</span> <span class="hljs-string">"google_compute_ssl_certificate"</span> <span class="hljs-string">"default"</span> <span class="hljs-string">{</span>
  <span class="hljs-string">project</span>     <span class="hljs-string">=</span> <span class="hljs-string">"${var.project}"</span>
  <span class="hljs-string">name_prefix</span> <span class="hljs-string">=</span> <span class="hljs-string">"${var.name}-certificate-"</span>
  <span class="hljs-string">private_key</span> <span class="hljs-string">=</span> <span class="hljs-string">"${var.private_key}"</span>
  <span class="hljs-string">certificate</span> <span class="hljs-string">=</span> <span class="hljs-string">"${var.certificate}"</span>

  <span class="hljs-string">lifecycle</span> <span class="hljs-string">=</span> <span class="hljs-string">{</span>
    <span class="hljs-string">create_before_destroy</span> <span class="hljs-string">=</span> <span class="hljs-literal">true</span>
  <span class="hljs-string">}</span>
<span class="hljs-string">}</span>
</div></code></pre>
<p>And firewall rules among other configuration options:</p>
<pre class="hljs"><code><div><span class="hljs-string">resource</span> <span class="hljs-string">"google_compute_firewall"</span> <span class="hljs-string">"default-hc"</span> <span class="hljs-string">{</span>
  <span class="hljs-string">project</span>       <span class="hljs-string">=</span> <span class="hljs-string">"${var.firewall_projects}"</span>
  <span class="hljs-string">name</span>          <span class="hljs-string">=</span> <span class="hljs-string">"${var.name}"</span>
  <span class="hljs-string">network</span>       <span class="hljs-string">=</span> <span class="hljs-string">"${var.firewall_networks}"</span>
  <span class="hljs-string">source_ranges</span> <span class="hljs-string">=</span> <span class="hljs-string">["46.6.3.128/28"]</span>
  <span class="hljs-string">target_tags</span>   <span class="hljs-string">=</span> <span class="hljs-string">["${var.target_tags}"]</span>

  <span class="hljs-string">allow</span> <span class="hljs-string">{</span>
    <span class="hljs-string">protocol</span> <span class="hljs-string">=</span> <span class="hljs-string">"tcp"</span>
    <span class="hljs-string">ports</span>    <span class="hljs-string">=</span> <span class="hljs-string">["${var.backend_params}"]</span>
  <span class="hljs-string">}</span>
</div></code></pre>
<p>One interesting concept is the <code>targed_tags</code> configured in the node_pools and referenced as example.</p>
<p>Fully recommended to read the code for the Terraform Google Modules on <a href="https://github.com/terraform-google-modules/terraform-google-kubernetes-engine">Github</a></p>
<h5 id="32225-connectivity">3.2.2.2.5 Connectivity</h5>
<p>We are not going to cover all the networking facts in this document as it could be a huge topic. In the other hand, VPN connectivity is important as most of the services needs to be protected through IAMS, 2FA and certificates when possible.</p>
<pre class="hljs"><code><div><span class="hljs-string">resource</span> <span class="hljs-string">"google_compute_vpn_tunnel"</span> <span class="hljs-string">"tunnel1"</span> <span class="hljs-string">{</span>
  <span class="hljs-string">name</span>          <span class="hljs-string">=</span> <span class="hljs-string">"tunnel1"</span>
  <span class="hljs-string">peer_ip</span>       <span class="hljs-string">=</span> <span class="hljs-string">"15.0.0.120"</span>
  <span class="hljs-string">shared_secret</span> <span class="hljs-string">=</span> <span class="hljs-string">"a secret message"</span>

  <span class="hljs-string">target_vpn_gateway</span> <span class="hljs-string">=</span> <span class="hljs-string">google_compute_vpn_gateway.target_gateway.id</span>
<span class="hljs-string">}</span>

<span class="hljs-string">resource</span> <span class="hljs-string">"google_compute_vpn_gateway"</span> <span class="hljs-string">"target_gateway"</span> <span class="hljs-string">{</span>
  <span class="hljs-string">name</span>    <span class="hljs-string">=</span> <span class="hljs-string">"vpn1"</span>
  <span class="hljs-string">network</span> <span class="hljs-string">=</span> <span class="hljs-string">"mynetwork"</span>
<span class="hljs-string">}</span>
</div></code></pre>
<h5 id="32226-zone-redundancy">3.2.2.2.6 Zone redundancy</h5>
<p>The Load balancer configuration will cover both Clusters in Zone A and Zone B for a distributed configuration and Zone redundancy.</p>
<h4 id="3223-terraform-versioned-modules">3.2.2.3 Terraform. Versioned modules</h4>
<p>Following the structure defined in the <a href="#3211-important-files-and-directories">Important</a>, it is important to define a release strategy for the modules. If you’re using GitHub, you can use the GitHub UI to create a release, which will create a tag under the hood.</p>
<p>Now you can use this versioned module in both staging and production by specifying a Git URL in the source parameter.</p>
<p>When using the module just specify the tag:</p>
<pre class="hljs"><code><div><span class="hljs-string">module</span> <span class="hljs-string">"webserver_cluster"</span> <span class="hljs-string">{</span>
  <span class="hljs-string">source</span> <span class="hljs-string">=</span> <span class="hljs-string">"github.com/imjoseangel/myterraform/modules/mycluster?ref=v0.0.1"</span>
</div></code></pre>
<h4 id="3224-other-services">3.2.2.4 Other Services</h4>
<p>As discussed before, the implementation of other PaaS will be performed in the same way. It is important to analyze the cost vs maintenance vs functionality for the given services. For instance, using PostgreSQL can be quite cheaper than using the firestore option. Creating IAAS services need VM Operating System maintenance and the backup options are not as straight-forwards than the one inside the PaaS, but it is important to take this option into account for small services and POCs.</p>
<p>Deployment a IaaS with terraform is quite straightforward (Besides Networking, firewalling, etc):</p>
<pre class="hljs"><code><div><span class="hljs-string">resource</span> <span class="hljs-string">"google_compute_instance"</span> <span class="hljs-string">"default"</span> <span class="hljs-string">{</span>
  <span class="hljs-string">name</span>         <span class="hljs-string">=</span> <span class="hljs-string">"myvm"</span>
  <span class="hljs-string">machine_type</span> <span class="hljs-string">=</span> <span class="hljs-string">"n1-standard-1"</span>
  <span class="hljs-string">zone</span>         <span class="hljs-string">=</span> <span class="hljs-string">"us-central1-a"</span>

  <span class="hljs-string">tags</span> <span class="hljs-string">=</span> <span class="hljs-string">["foo",</span> <span class="hljs-string">"bar"</span><span class="hljs-string">]</span>

  <span class="hljs-string">boot_disk</span> <span class="hljs-string">{</span>
    <span class="hljs-string">initialize_params</span> <span class="hljs-string">{</span>
      <span class="hljs-string">image</span> <span class="hljs-string">=</span> <span class="hljs-string">"debian-cloud/debian-10"</span>
    <span class="hljs-string">}</span>
  <span class="hljs-string">}</span>

  <span class="hljs-string">//</span> <span class="hljs-string">Local</span> <span class="hljs-string">SSD</span> <span class="hljs-string">disk</span>
  <span class="hljs-string">scratch_disk</span> <span class="hljs-string">{</span>
    <span class="hljs-string">interface</span> <span class="hljs-string">=</span> <span class="hljs-string">"SCSI"</span>
  <span class="hljs-string">}</span>

  <span class="hljs-string">network_interface</span> <span class="hljs-string">{</span>
    <span class="hljs-string">network</span> <span class="hljs-string">=</span> <span class="hljs-string">"default"</span>

    <span class="hljs-string">access_config</span> <span class="hljs-string">{</span>
    <span class="hljs-string">}</span>
  <span class="hljs-string">}</span>

  <span class="hljs-string">service_account</span> <span class="hljs-string">{</span>
    <span class="hljs-string">scopes</span> <span class="hljs-string">=</span> <span class="hljs-string">["userinfo-email",</span> <span class="hljs-string">"compute-ro"</span><span class="hljs-string">,</span> <span class="hljs-string">"storage-ro"</span><span class="hljs-string">]</span>
  <span class="hljs-string">}</span>
<span class="hljs-string">}</span>
</div></code></pre>
<p>The important part is to configure and harden it properly. Here is were the Compliance as Code and Ansible mark the difference. Chef for testing, Ansible to implement it. We will discuss this later in the security section. <a href="https://github.com/dev-sec">GitHub Link</a></p>
<h4 id="3225-section-2bansible-kubernetes-operators-microservices-deployment">3.2.2.5 Section _2b_Ansible. Kubernetes Operators. Microservices Deployment</h4>
<p>Ansible is perfect to create operators to be deployed. A K8S Operator can complete complex tasks in order to achieve the desired changes in the application’s output. It is clear that Operators is the present and the future to manage Kubernetes clusters.</p>
<p>It can automatically handle such tasks as:</p>
<ul>
<li>Deploying applications</li>
<li>Updating applications to new versions</li>
<li>Reconfiguring application settings</li>
<li>Scaling applications up and down depending on usage</li>
<li>Failure handling</li>
<li>Setting up monitoring infrastructure</li>
</ul>
<p>The Kubernetes Operator is able to modify the configuration and usage of an application based on the application’s output. This is determined by the custom resources defined for that application. Custom resources showing the desired state and custom resources showing the current state form a loop. The Operator observes the current state and then takes actions that will make the application produce the desired state. After the actions are executed, the current state is reevaluated and the loop begins again.</p>
<p>For example, a custom resource could define the desirable state of a new server instance as some amount of load capability based on its physical resources.The Operator would then adjust the configuration until new instances reached these standards.</p>
<p>Creating an Ansible Operator:</p>
<p>As simple as:</p>
<pre class="hljs"><code><div>operator-sdk init --plugins=ansible --domain example.com
</div></code></pre>
<p>We will create the API:</p>
<pre class="hljs"><code><div>operator-sdk create api --group myapp --version v1alpha1 --kind MyApp --generate-role
</div></code></pre>
<p>One of the most important files here is the <code>watches.yml</code> file. Reference <a href="https://sdk.operatorframework.io/docs/building-operators/ansible/reference/watches/">here</a></p>
<p>For the logic, we will just configure the Ansible Role:</p>
<pre class="hljs"><code><div><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">start</span> <span class="hljs-string">myapp</span>
  <span class="hljs-attr">community.kubernetes.k8s:</span>
    <span class="hljs-attr">definition:</span>
      <span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
      <span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
      <span class="hljs-attr">metadata:</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">'<span class="hljs-template-variable">{{ ansible_operator_meta.name }}</span>-myapp'</span>
        <span class="hljs-attr">namespace:</span> <span class="hljs-string">'<span class="hljs-template-variable">{{ ansible_operator_meta.namespace }}</span>'</span>
      <span class="hljs-attr">spec:</span>
        <span class="hljs-attr">replicas:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{size}}</span>"</span>
        <span class="hljs-attr">selector:</span>
          <span class="hljs-attr">matchLabels:</span>
            <span class="hljs-attr">app:</span> <span class="hljs-string">myapp</span>
        <span class="hljs-attr">template:</span>
          <span class="hljs-attr">metadata:</span>
            <span class="hljs-attr">labels:</span>
              <span class="hljs-attr">app:</span> <span class="hljs-string">myapp</span>
          <span class="hljs-attr">spec:</span>
            <span class="hljs-attr">containers:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">myapp</span>
              <span class="hljs-attr">command:</span>
              <span class="hljs-bullet">-</span> <span class="hljs-string">myapp</span>
              <span class="hljs-attr">image:</span> <span class="hljs-string">"docker.io/myapp:1"</span>
              <span class="hljs-attr">ports:</span>
                <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8080</span>
</div></code></pre>
<p>This is the main configuration. To finish and push the container to the registry:</p>
<pre class="hljs"><code><div>make docker-build docker-push IMG=docker.io/myapp:1
</div></code></pre>
<p>And to deploy it:</p>
<pre class="hljs"><code><div><span class="hljs-built_in">export</span> IMG=docker.io/myapp:1
make deploy
</div></code></pre>
<pre class="hljs"><code><div>kubectl apply -f config/samples/cache_v1alpha1_myapp.yaml
</div></code></pre>
<h3 id="323-section-3-testing">3.2.3 Section <em>3</em>. Testing</h3>
<p>Before continuing with other sections, it is fundamental to define how to test or developments and integrations. There will be different test phases, some running on our local computers, some on CI and some when going to production. We are going to try to conver some and going through the most important phases.</p>
<h3 id="3231-pre-commit">3.2.3.1 Pre-Commit</h3>
<p>It hooks <em>git</em> scripts for identifying simple issues in the code that's about to be committed. We will use pre-commit for linting and security.</p>
<p>##### The <code>.pre-commit-config.yaml</code> file</p>
<p>This file is located in the root of every project with the different tasks to run:</p>
<pre class="hljs"><code><div><span class="hljs-meta">---</span>
<span class="hljs-attr">repos:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">repo:</span> <span class="hljs-string">local</span>
    <span class="hljs-attr">hooks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">ansible-lint</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">Ansible-lint</span>
        <span class="hljs-attr">description:</span> <span class="hljs-string">This</span> <span class="hljs-string">hook</span> <span class="hljs-string">runs</span> <span class="hljs-string">ansible-lint.</span>
        <span class="hljs-attr">entry:</span> <span class="hljs-string">ansible-lint</span>
        <span class="hljs-attr">language:</span> <span class="hljs-string">system</span>
        <span class="hljs-attr">files:</span> <span class="hljs-string">\.(yaml|yml)$</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">yamllint</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">yamllint</span>
        <span class="hljs-attr">args:</span> <span class="hljs-string">['--strict']</span>
        <span class="hljs-attr">entry:</span> <span class="hljs-string">yamllint</span>
        <span class="hljs-attr">language:</span> <span class="hljs-string">system</span>
        <span class="hljs-attr">types:</span> <span class="hljs-string">[file,</span> <span class="hljs-string">yaml]</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">terraform_fmt</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">terraform_fmt</span>
        <span class="hljs-attr">description:</span> <span class="hljs-string">Formats</span> <span class="hljs-string">terraform</span> <span class="hljs-string">scripts</span> <span class="hljs-string">into</span> <span class="hljs-string">the</span> <span class="hljs-string">correct</span> <span class="hljs-string">checkstyle</span>
        <span class="hljs-attr">entry:</span> <span class="hljs-string">bin/tf_fmt.sh</span>
        <span class="hljs-attr">language:</span> <span class="hljs-string">script</span>
        <span class="hljs-attr">files:</span> <span class="hljs-string">\.tf$</span>
        <span class="hljs-attr">exclude:</span> <span class="hljs-string">\.terraform\/.*$</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">terraform_validate</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">terraform_validate</span>
        <span class="hljs-attr">description:</span> <span class="hljs-string">Validates</span> <span class="hljs-string">terraform</span> <span class="hljs-string">scripts</span> <span class="hljs-string">syntax</span>
        <span class="hljs-attr">entry:</span> <span class="hljs-string">bin/tf_validate.sh</span>
        <span class="hljs-attr">language:</span> <span class="hljs-string">script</span>
        <span class="hljs-attr">files:</span> <span class="hljs-string">\.tf$</span>
        <span class="hljs-attr">exclude:</span> <span class="hljs-string">\.terraform\/.*$</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">detect-secrets</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">Detect</span> <span class="hljs-string">Secrets</span>
        <span class="hljs-attr">description:</span> <span class="hljs-string">This</span> <span class="hljs-string">hook</span> <span class="hljs-string">detects</span> <span class="hljs-string">and</span> <span class="hljs-string">prevents</span> <span class="hljs-string">high</span> <span class="hljs-string">entropy</span> <span class="hljs-string">strings</span> <span class="hljs-string">from</span> <span class="hljs-string">entering</span> <span class="hljs-string">the</span> <span class="hljs-string">codebase.</span>
        <span class="hljs-attr">entry:</span> <span class="hljs-string">detect-secrets-hook</span>
        <span class="hljs-attr">language:</span> <span class="hljs-string">system</span>

  <span class="hljs-bullet">-</span> <span class="hljs-attr">repo:</span> <span class="hljs-string">git://github.com/pre-commit/pre-commit-hooks</span>
    <span class="hljs-attr">rev:</span> <span class="hljs-string">v2.5.0</span>
    <span class="hljs-attr">hooks:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">check-yaml</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">end-of-file-fixer</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">trailing-whitespace</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">check-case-conflict</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">check-merge-conflict</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">check-executables-have-shebangs</span>
</div></code></pre>
<p>The idea of the pre-commit is running basic code tests on every commit and ensure that the code does not contain basic security issues (Passwords or tokens). <em>Linting</em> is the process of checking the source code for <em>Programmatic</em> as well as <em>Stylistic</em> errors. This is most helpful in identifying some common and uncommon mistakes that are made during coding. - <a href="https://stackoverflow.com/questions/8503559/what-is-linting">StackOverflow</a>.</p>
<p>Depending on the programming language, different linters need to be defined. For instance <code>rubocop</code> for Ruby or <code>shellcheck</code> for shell scripting. There are other generic as <code>trailing-whitespace</code> that trims trailing whitespace or <code>end-of-file-fixer</code> that ensures that a file is either empty, or ends with one newline.</p>
<p>Check <a href="https://pre-commit.com/hooks.html">pre-commit hooks page</a> and <a href="https://github.com/pre-commit/pre-commit-hooks">GitHub</a> for more info.</p>
<h3 id="3232-code-testing-and-integration-tests-on-ci">3.2.3.2 Code Testing and Integration Tests on CI</h3>
<p>The most typical tool for Static Analysis and Unit Testing is Sonar, but on CI and mostly for Infrastructure, unit testing are not easy to find. If we don't require cool reporting boards, but we want to keep quality, the same <code>pre-commit</code> hooks can be reutilized in Continous Integration (Sanity Testing) together with the Integration Tests.</p>
<p>There are two nice tools to test our deployments: <code>molecule</code> and <code>inspec</code>. Both are really powerful and good options with low learning curve. We will use both for operators and security respectively so is a question of deciding as a team what is the best option for integration testing. Both tools can work together and molecule support inspec as assertion tool.</p>
<p>As said, <code>molecule</code> tests can integrate also infrastructure and operators testing like:</p>
<pre class="hljs"><code><div><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Assert</span> <span class="hljs-string">provisioning,</span> <span class="hljs-string">acls</span> <span class="hljs-string">and</span> <span class="hljs-string">secrets</span>
  <span class="hljs-attr">assert:</span>
    <span class="hljs-attr">that:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">vaultspolicies</span> <span class="hljs-string">is</span> <span class="hljs-string">iterable</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">vaultspolicies</span> <span class="hljs-string">|</span> <span class="hljs-string">length()</span> <span class="hljs-string">==</span> <span class="hljs-number">1</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"'<span class="hljs-template-variable">{{ vaults[ ].name }}</span>' == 'myvault'"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"'<span class="hljs-template-variable">{{ vaults[ ].vault_uri }}</span>' == 'https://myvault'"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">vaultspolicies[</span> <span class="hljs-string">].object_id</span> <span class="hljs-string">is</span> <span class="hljs-string">match('[A-Za-z0-9]{8}\-[A-Za-z0-9]{4}\-[A-Za-z0-9]{4}\-[A-Za-z0-9]{4}\-[A-Za-z0-9]{12}')</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">vaultssecrets</span> <span class="hljs-string">|</span> <span class="hljs-string">length()</span> <span class="hljs-string">==</span> <span class="hljs-number">2</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"'<span class="hljs-template-variable">{{ vaultssecrets[ ].key }}</span>' == 'molecule'"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"'<span class="hljs-template-variable">{{ vaultssecrets[ ].value }}</span>' == 'M013cu13'"</span>
</div></code></pre>
<p>And Inspec</p>
<pre class="hljs"><code><div>describe <span class="hljs-string">"services"</span> <span class="hljs-keyword">do</span>
  describe <span class="hljs-string">"nginx"</span> <span class="hljs-keyword">do</span>
    let(<span class="hljs-symbol">:service</span>) { client.get_service(<span class="hljs-string">"terraform-example"</span>, <span class="hljs-string">"default"</span>) }
    let(<span class="hljs-symbol">:service_load_balancer_ip</span>) { service.status.loadBalancer.ingress.first.ip }
    let(<span class="hljs-symbol">:service_load_balancer_address</span>) { <span class="hljs-string">"http://<span class="hljs-subst">#{service_load_balancer_ip}</span>:8080"</span> }

    it <span class="hljs-string">"exists"</span> <span class="hljs-keyword">do</span>
      expect(service).not_to be_nil
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</div></code></pre>
<p>Another option for infrastructure with Terraform is <a href="https://github.com/gruntwork-io/terratest">terratest</a>. The assertions are developed in <strong>golang</strong> and the integration with Terraform is really good and go native but the learning curve is higher and it is more difficult to maintain.</p>
<h3 id="3233-performance-testing">3.2.3.3 Performance Testing</h3>
<h3 id="32331-operator-sdk-testing">3.2.3.3.1 Operator SDK Testing</h3>
<p>Operators have their own molecule tests that will run on CI. A complement for performance is also the <a href="https://github.com/geerlingguy/operator-sdk-performance-testing">Operator SDK Performance Testing</a>. This framework can test the operators performance using <strong>Ansible</strong> and give a good view of how to run different <em>molecule</em> test for K8S.</p>
<h3 id="32332-jmeter-testing-and-api-mocking">3.2.3.3.2 JMeter Testing and API Mocking</h3>
<p>The best way to test the performance of most of the components in this arquitecture is using JMeter. We can use the JMeter operator from <a href="https://github.com/kubernauts/jmeter-operator">Kubernauts</a> that gives also a grafana frondend to visualize the metrics. It is important to prepare the proper test for a given application. The API performance tests can be mocked with <a href="http://wiremock.org/">wiremock</a>.</p>
<h3 id="3234-resilience-testing">3.2.3.4 Resilience Testing</h3>
<p>This is the most difficult part to achieve but it is important to be prepared for a Disaster. We will talk about recovery and resilence later, but we will focus in <em>Chaos experiments</em>.</p>
<p>The <a href="https://docs.chaostoolkit.org/">Chaos Toolkit</a> is one of the simples approach to start learning and experimenting with our platform with hypotetical scenarios. An example is in their <a href="https://docs.chaostoolkit.org/reference/tutorial/">tuto page</a> when it tests what happens when a SSL certificate expires:</p>
<pre class="hljs"><code><div>{
    <span class="hljs-attr">"type"</span>: <span class="hljs-string">"probe"</span>,
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"the-astre-service-must-be-running"</span>,
    <span class="hljs-attr">"tolerance"</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">"provider"</span>: {
        <span class="hljs-attr">"type"</span>: <span class="hljs-string">"python"</span>,
        <span class="hljs-attr">"module"</span>: <span class="hljs-string">"os.path"</span>,
        <span class="hljs-attr">"func"</span>: <span class="hljs-string">"exists"</span>,
        <span class="hljs-attr">"arguments"</span>: {
            <span class="hljs-attr">"path"</span>: <span class="hljs-string">"astre.pid"</span>
        }
    }
},
{
    <span class="hljs-attr">"type"</span>: <span class="hljs-string">"action"</span>,
    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"swap-to-expired-cert"</span>,
    <span class="hljs-attr">"provider"</span>: {
        <span class="hljs-attr">"type"</span>: <span class="hljs-string">"process"</span>,
        <span class="hljs-attr">"path"</span>: <span class="hljs-string">"cp"</span>,
        <span class="hljs-attr">"arguments"</span>: <span class="hljs-string">"expired-cert.pem cert.pem"</span>
    }
}
</div></code></pre>
<p>The important point here is the concept and having that resilience in mind in the pre and post-deployment. Besides the SSL, there are other ways to chaos our Infrastructure and Applications:</p>
<ul>
<li>Network Failures</li>
<li>Maximize Out Resources</li>
<li>Simulate External Traffic (China, India, Russia, etc.)</li>
<li>Block DNS</li>
<li>Storage Failures, Overload</li>
<li>In-Memory Failure</li>
</ul>
<h3 id="324-section-4a-code-and-cicd-security">3.2.4 Section <em>4a</em>. Code and CI/CD Security</h3>
<p>Security must be part of the whole architecture, including networking, certificates and passwords, code security, platform and cloud security. We won't cover Layer3 firewall rules in depth as it is a basic concept commented when deploying K8S.</p>
<h4 id="3241-code-security---sast-sca-and-cva">3.2.4.1 Code Security - SAST, SCA and CVA</h4>
<p><strong>SAST</strong> is something we have been talk already with pre-commit and CI Testing. It stands for Static Analysis and Security Testing. These security tools look for vulnerabilities in the way code is written. GitHub offers an integrated solution call CodeQL Analysis supporting <em>C, C++, C#, Java, JavaScript, TypeScript, Python, and Go</em>.</p>
<p><strong>SCA</strong> looks for Open Source Software vulnerabilities in our applications and code. This is the most important as they identify the majority of security and policy issues in the applications and are extremely fast with a low false positive rate. GitHub <em>Dependabot</em> is an integrated service to do this job.</p>
<p><strong>CVA or CSA</strong> stands for Container Vulnerability / Security Analysis. It refers to the analysis of containers and images (Docker, etc) for security vulnerabilities. The project <a href="https://github.com/quay/clair">clair</a> or <a href="https://github.com/marketplace/actions/anchore-container-scan">Anchore</a> are a good references.</p>
<h4 id="3242-compliance-as-code">3.2.4.2 Compliance as Code</h4>
<p>Chef InSpec is an open-source framework for testing and auditing your applications and infrastructure. Chef InSpec works by comparing the actual state of your system with the desired state that you express in easy-to-read and easy-to-write Chef InSpec code. Chef InSpec detects violations and displays findings in the form of a report, but puts you in control of remediation.</p>
<p>The structure has been explained in the <a href="#3214-compliance-as-code---chef-git-structure">section</a></p>
<p>The <code>inspec.yml</code> file contains the attributes or variables for the different operations:</p>
<p>In the following example we define the attribute <code>hklm_null_session_pipes</code> as an empty array:</p>
<pre class="hljs"><code><div><span class="hljs-attr">attributes:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">hklm_null_session_pipes</span>
      <span class="hljs-attr">required:</span> <span class="hljs-literal">false</span>
      <span class="hljs-attr">description:</span> <span class="hljs-string">'define named pipes that can be accessed anonymously'</span>
      <span class="hljs-attr">value:</span> <span class="hljs-string">[]</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">array</span>
</div></code></pre>
<p>The controls contain the different assertions to check. In the example, we check that the cluster should be running.</p>
<pre class="hljs"><code><div>describe google_container_cluster(<span class="hljs-symbol">project:</span> <span class="hljs-string">'chef-inspec-gcp'</span>, <span class="hljs-symbol">location:</span> <span class="hljs-string">'europe-west2-a'</span>, <span class="hljs-symbol">name:</span> <span class="hljs-string">'inspec-gcp-kube-cluster'</span>) <span class="hljs-keyword">do</span>
  its(<span class="hljs-string">'status'</span>) { should eq <span class="hljs-string">'RUNNING'</span> }
<span class="hljs-keyword">end</span>
</div></code></pre>
<p>The important part is the compliance framework available at <a href="https://github.com/dev-sec">DevSec</a>. When using IaaS it is fully recommended to apply the different hardening configurations available for ansible and check with the official CIS Frameworks.</p>
<p>There are also checks available for the Cloud. For instance and continuing with GCP, it is available <a href="https://github.com/inspec/inspec-gcp">here</a>.</p>
<p>It is important to define a project per framework and run them like:</p>
<pre class="hljs"><code><div>inspec <span class="hljs-built_in">exec</span> https://github.com/dev-sec/linux-baseline -b winrm --host myserver --user myuser --password mypassword --reporter=json-min<span class="hljs-string">'
</span></div></code></pre>
<p>A good example can be running inspec with Ansible:</p>
<pre class="hljs"><code><div>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Find</span> <span class="hljs-string">Inspec</span> <span class="hljs-string">Executable</span>
      <span class="hljs-attr">set_fact:</span>
        <span class="hljs-attr">inspec_binary:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ item }}</span>"</span>
      <span class="hljs-attr">with_first_found:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">/usr/bin/inspec</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">/usr/local/bin/inspec</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Create</span> <span class="hljs-string">Linux</span> <span class="hljs-string">Inspec</span> <span class="hljs-string">cmd</span>
      <span class="hljs-attr">set_fact:</span>
        <span class="hljs-attr">command_line:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ inspec_binary +' exec '+ baselinefile +' -b ssh --host '+ ansible_host +' --user '+ user +' --password '+ password +' --reporter=json-min' }}</span>"</span>
      <span class="hljs-attr">no_log:</span> <span class="hljs-literal">true</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Run</span> <span class="hljs-string">inspec</span>
      <span class="hljs-attr">command:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ command_line }}</span>"</span>
      <span class="hljs-attr">when:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">register:</span> <span class="hljs-string">_out</span>
      <span class="hljs-attr">ignore_errors:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">no_log:</span> <span class="hljs-literal">true</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Capture</span> <span class="hljs-string">Inspec</span> <span class="hljs-string">Results</span>
      <span class="hljs-attr">set_fact:</span>
        <span class="hljs-attr">inspec_results_list:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ inspec_results_list|default([]) +  [ item|from_json() ]  }}</span>"</span>
      <span class="hljs-attr">with_items:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ _out.stdout_lines }}</span>"</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Flatten</span> <span class="hljs-string">inspec_results</span> <span class="hljs-string">list</span>
      <span class="hljs-attr">set_fact:</span>
        <span class="hljs-attr">inspec_results:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ inspec_results|default([]) + item.controls }}</span>"</span>
      <span class="hljs-attr">with_flattened:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ inspec_results_list }}</span>"</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Show</span> <span class="hljs-string">Results</span>
      <span class="hljs-attr">debug:</span>
        <span class="hljs-attr">var:</span> <span class="hljs-string">inspec_results</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Capture</span> <span class="hljs-string">Failed</span> <span class="hljs-string">Controls</span>
      <span class="hljs-attr">set_fact:</span>
        <span class="hljs-attr">failed_controls:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ inspec_results | selectattr('status','equalto','failed') | list }}</span>"</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Create</span> <span class="hljs-string">Failed</span> <span class="hljs-string">Controls</span> <span class="hljs-string">Dictionary</span>
      <span class="hljs-attr">set_fact:</span>
        <span class="hljs-attr">failed_controls_list:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ failed_controls_list | default ([]) + [ { 'server' : inventory_hostname, 'title' : item.id, 'description' : item.message.split('(compared')[ ].replace('\\r\\n', '') } ] }}</span>"</span>
      <span class="hljs-attr">with_items:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ failed_controls }}</span>"</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Set</span> <span class="hljs-string">var</span> <span class="hljs-string">for</span> <span class="hljs-string">Reporting</span>
      <span class="hljs-attr">set_fact:</span>
        <span class="hljs-attr">localreport:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ localreport | default ([]) + hostvars[item].failed_controls_list | default([]) }}</span>"</span>
      <span class="hljs-attr">with_items:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ groups['compliance1'] }}</span>"</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ groups['compliance2'] }}</span>"</span>
      <span class="hljs-attr">run_once:</span> <span class="hljs-literal">true</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Debug</span> <span class="hljs-string">localreport</span>
      <span class="hljs-attr">debug:</span>
        <span class="hljs-attr">msg:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ hostvars.localhost.localreport }}</span>"</span>
      <span class="hljs-attr">run_once:</span> <span class="hljs-literal">true</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Debug</span> <span class="hljs-string">Play</span> <span class="hljs-string">Hosts</span>
      <span class="hljs-attr">debug:</span>
        <span class="hljs-attr">msg:</span> <span class="hljs-string">"<span class="hljs-template-variable">{{ play_hosts }}</span>"</span>
      <span class="hljs-attr">run_once:</span> <span class="hljs-literal">true</span>

    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Generate</span> <span class="hljs-string">report</span>
      <span class="hljs-attr">template:</span>
        <span class="hljs-attr">src:</span> <span class="hljs-string">inspec_report.j2</span>
        <span class="hljs-attr">dest:</span> <span class="hljs-string">/tmp/inspec_report.txt</span>
      <span class="hljs-attr">changed_when:</span> <span class="hljs-literal">false</span>
</div></code></pre>
<p>The <code>inspec_report.j2</code> file looks like:</p>
<pre class="hljs"><code><div><span class="hljs-template-variable">{{ "%s, %s, %s" | format("Server", "Title", "Description") }}</span><span class="xml">
</span><span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">for</span></span> item <span class="hljs-keyword">in</span> hostvars.localhost.localreport %}</span><span class="xml">
</span><span class="hljs-template-variable">{{ "%s, %s, %s" | format(item.server, item.title, item.description.replace('\n', '') ) }}</span><span class="xml">
</span><span class="hljs-template-tag">{% <span class="hljs-name"><span class="hljs-name">endfor</span></span> %}</span><span class="xml">
</span></div></code></pre>
<h3 id="325-section-4b-passwords-and-certificates-security">3.2.5 Section <em>4b</em>. Passwords and Certificates Security</h3>
<p>When asking to the most geeky security guys and talking about protecting and securing secrets and certificates when doing automation, all have the same answer: <em>Hashicorp Vault</em></p>
<ul>
<li>
<p>It supports most of the major cloud platforms out of the box. The <a href="https://www.vaultproject.io/docs/secrets/gcp">Google Cloud Vault</a> secrets engine dynamically generates Google Cloud service account keys and OAuth tokens based on IAM policies. This enables users to gain access to Google Cloud resources without needing to create or manage a dedicated service account.</p>
</li>
<li>
<p>It is perfect for secrets consolidation. Example for <a href="https://support.circleci.com/hc/en-us/articles/360006717953-Storing-Secret-Files-certs-etc-">CircleCI</a>.</p>
</li>
<li>
<p>It generates and store credentials through cli or API. Passwords can be generated on-the-fly while using and storing it without jeopardizing security. Also it can generate Temporary passwords with TTL. As said, all the secrets can be automated through its API.</p>
</li>
</ul>
<h3 id="326-section-4c-waf-and-security-audit---armor">3.2.6 Section <em>4c</em>. WAF and Security Audit - Armor</h3>
<p>Google Armor is not cheap but something to take into account. It is quite difficult to protect applications exposed to the internet. The combination of Google Cloud Armor with Google Cloud Load Balancing protect the applications against the web’s most common attacks, provide granular Layer 7 access controls, and defend against volumetric, protocol and application-level DDoS attacks.</p>
<h3 id="327-section-5-continuous-integration-and-deployment">3.2.7 Section <em>5</em>. Continuous Integration and Deployment</h3>
<p>This is another long topic to cover. I find interesting to comment few tips and add some links as reference.</p>
<p>GitHub actions are becoming more and more popular with new cool features every other week and a really good support and integration. Going to another tool like CircleCI and back needs to be painless and it is important to choose similar ways of working between tools: <a href="https://circleci.com/docs/2.0/migrating-from-github/">Migrating from Github Actions</a>.</p>
<p>As good practices:</p>
<ul>
<li>It is important to have the possibility to run test manually without creating a new commit every time.</li>
<li>Test only new files on commits and the related integration on PR.</li>
<li>Try to test on production-like environments.</li>
<li>Do powerful and fast tests. The more the test take, the less the tool will be utilized.</li>
<li>Automate every test not only the simple ones.</li>
<li>Report the status to all the team. Show up your tests and failures.</li>
</ul>
<p><em>Ansible</em>, <em>Terraform</em> and <em>Chef</em> can be easily integrated with any modern CI Solution:</p>
<ul>
<li><strong>Ansible</strong></li>
</ul>
<pre class="hljs"><code><div><span class="hljs-bullet">-</span> <span class="hljs-attr">run:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">to</span> <span class="hljs-string">production</span>
  <span class="hljs-attr">command:</span> <span class="hljs-string">|
    . env/bin/activate
    ansible-playbook -i ansible/hosts ansible/deployment.yml
</span></div></code></pre>
<ul>
<li><strong>Terraform</strong></li>
</ul>
<pre class="hljs"><code><div><span class="hljs-bullet">-</span> <span class="hljs-attr">run:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">terraform</span> <span class="hljs-string">plan</span>
    <span class="hljs-attr">command:</span> <span class="hljs-string">|
      source $BASH_ENV
      cd ~/project/
      terraform plan
</span></div></code></pre>
<ul>
<li><strong>Inspec</strong></li>
</ul>
<pre class="hljs"><code><div><span class="hljs-bullet">-</span> <span class="hljs-attr">run:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">Inspec</span> <span class="hljs-string">production</span>
  <span class="hljs-attr">command:</span> <span class="hljs-string">|
    inspec exec https://github.com/dev-sec/linux-baseline -b winrm --host myserver --user myuser --password mypassword --reporter=json-min'
</span></div></code></pre>
<h3 id="328-section-6-logging-metrics-and-traceability">3.2.8 Section <em>6</em>. Logging, Metrics and Traceability</h3>
<p>In the presented architecture, there are two flavours when talking about metrics, logging and traceability.</p>
<p><em>IaaS or Single Servers</em>. These can easily monitored using metrics and parameters like CPU Speed, IOPS or Memory comsumption. It is important to choose the right metrics in quality and quantity. Analyzing too many data points continuously will generate volumes of unnecessary alerts, data, and false flags.</p>
<p><strong>Zabbix</strong> is one of the best real-time monitoring product and can collect metrics from any devices, systems, applications and databases. In the next section we will see options to connect to the Kubernetes monitoring.</p>
<p><em>Kubernetes</em>. Due to the complexity of Kubernetes and microservices, we need to analyze its performance and service dependencies with different tools. Probably the most known and already integrated in many clouds is:</p>
<p><strong>Prometheus</strong> does one thing and it does it well. It has a simple yet powerful data model and a query language that lets you analyse how your applications and infrastructure are performing. It does not try to solve problems outside of the metrics space, leaving those to other more appropriate tools. It can be run in Kubernetes using a <a href="https://github.com/coreos/prometheus-operator">Kubernetes Operator</a> or in a stand-alone mode. Prometheus uses exporters to allow third party data to be brought into its data store.</p>
<p><strong>Grafana</strong> is the perfect companion for <strong>Prometheus</strong> as it processes the raw metrics and allow to query, visualize, alert on and understand them. Grafana has many plugins and it is important to choose the right ones.</p>
<ul>
<li>The number of failing pods and errors within a specific namespace.</li>
<li>Resource utilization saturation—the containers’ resource consumption and allocation.</li>
<li>Kubernetes resource capacity—the total number of nodes, CPU cores, and memory available.</li>
</ul>
<p>Also we can add the <a href="https://grafana.com/grafana/plugins/alexanderzobnin-zabbix-app">Zabbix</a> plugin to integrate the core metrics from Zabbix with the ones comming from Kubernetes.</p>
<p><strong>Fluentd</strong> is an open-source data collector for unified logging layers. It uses a <em>DaemonSet</em> that ensures that all (or some) Nodes run a copy of a Pod. As nodes are added to the cluster, Pods are added to them. As nodes are removed from the cluster, those Pods are garbage collected.</p>
<p>Together with <strong>ELK</strong> (Elasticsearch, Logstash, and Kibana). All the log messages generated as some sort of event and stream it into a single storage ordered by timestamp. This channeling of logs/messages/texts is done by Logstash. These messages/texts are now fed into Elastic clusters. Elastic Clusters mainly do something called ‘reverse indexing’. All the messages are stored as a document and are indexed using the words, phrases. Kibana acts as the front end UI for the whole stack providing an interface where you can query for messages using a specified query language, generate charts/visualizations and so on.</p>
<p><strong>ELK</strong> can be installed using an <a href="https://operatorhub.io/operator/elastic-cloud-eck">operator</a>. More information also <a href="https://www.elastic.co/blog/introducing-elastic-cloud-on-kubernetes-the-elasticsearch-operator-and-beyond">here</a>.</p>
<p>As said, <strong>Fluend</strong> can send logs to <strong><a href="https://docs.fluentd.org/output/elasticsearch">ELK</a></strong>. For instance:</p>
<pre class="hljs"><code><div><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">extensions/v1beta1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">DaemonSet</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">fluentd</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-syste</span>
<span class="hljs-attr">spec:</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-string">–</span> <span class="hljs-attr">name:</span> <span class="hljs-string">fluentd</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">quay.io/fluent/fluentd-kubernetes-daemonset</span>
        <span class="hljs-attr">env:</span>
          <span class="hljs-string">–</span> <span class="hljs-attr">name:</span>  <span class="hljs-string">FLUENT_ELASTICSEARCH_HOST</span>
            <span class="hljs-attr">value:</span> <span class="hljs-string">“elasticsearch-logging”</span>
          <span class="hljs-string">–</span> <span class="hljs-attr">name:</span>  <span class="hljs-string">FLUENT_ELASTICSEARCH_PORT</span>
            <span class="hljs-attr">value:</span> <span class="hljs-string">“9200”</span>
          <span class="hljs-string">–</span> <span class="hljs-attr">name:</span>  <span class="hljs-string">FLUENT_ELASTICSEARCH_SSL_VERIFY</span>
            <span class="hljs-attr">value:</span> <span class="hljs-string">“true”</span>
          <span class="hljs-string">–</span> <span class="hljs-attr">name:</span>  <span class="hljs-string">FLUENT_ELASTICSEARCH_SSL_VERSION</span>
            <span class="hljs-attr">value:</span> <span class="hljs-string">“TLSv1_2”</span>
</div></code></pre>
<p>Also it is available as an <a href="https://github.com/vmware/kube-fluentd-operator">operator</a>.</p>
<p>Finally, we will name <strong><a href="https://www.jaegertracing.io/">Jaeger</a></strong> as an end-to-end distributed tracing tool developed by Uber. It will trace all microservices communication and show request/response, errors on its dashboard. The tool is designed to monitor and troubleshoot distributed microservices:</p>
<ul>
<li>Distributed context propagation</li>
<li>Distributed transaction monitoring</li>
<li>Root cause analysis</li>
<li>Service dependency analysis</li>
<li>Performance/latency optimization</li>
</ul>
<p><strong>Jaeger</strong> can be deployed in Kubernetes using <a href="https://www.jaegertracing.io/docs/1.16/operator/">Jaeger Operator</a>.</p>
<h3 id="3281-google-cloud-operations-stackdriver">3.2.8.1 Google Cloud Operations (Stackdriver)</h3>
<p>A very important option to take into account and discuss is a Cloud Based solution. <a href="https://cloud.google.com/products/operations">GCP Stackdriver</a> provides most of the solutions for the specific cloud, but that is also its weak point. If we want to go multicloud for redundancy, we should look for a centralized dashboard for all of them. Another weak point is pricing. We need to be careful when using central logging and the way to manage logs.</p>
<h4 id="32811-log-definition-and-best-practices">3.2.8.1.1 Log Definition and Best Practices</h4>
<p>It is important to have a commong logging strategy in the solution and define a common goal. We need to avoid log noise but have the right logs for proper debugging and troubleshooting. Also, we need to avoid extra logs to avoid extra costs and storage.</p>
<p>It is important to standardize the logs to have a common way to parse most of them and subsequently analyze them. This means creating standards for formatting and naming fields. Regarding formatting, the most commonly used is <em>JSON</em> and <em>Key-Value-Pairs</em>. It is important to choose also the standard thinking in the context we are. If it’s the ELK Stack, for example, JSON is the format you will want to use. To finalize, remember to provide context to the logs with the right information and mapping.</p>
<pre class="hljs"><code><div>{
  <span class="hljs-attr">"@timestamp"</span>: <span class="hljs-string">"2017-07025 17:02:12"</span>,
  <span class="hljs-attr">"level"</span>: <span class="hljs-string">"error"</span>,
  <span class="hljs-attr">"message"</span>: <span class="hljs-string">"connection refused"</span>,
  <span class="hljs-attr">"service"</span>: <span class="hljs-string">"listener"</span>,
  <span class="hljs-attr">"thread"</span>: <span class="hljs-string">"125"</span>,
  <span class="hljs-attr">"customerid"</span>: <span class="hljs-string">"776622"</span>,
  <span class="hljs-attr">"ip"</span>: <span class="hljs-string">"34.124.233.12"</span>,
  <span class="hljs-attr">"queryid"</span>: <span class="hljs-string">"45"</span>
}
</div></code></pre>
<h4 id="3282-k8s-health-checks-and-metrics">3.2.8.2 K8S Health Checks and Metrics</h4>
<p>We are not going to go deep on this matter as this is basic when developing an application for kubernetes. It is a must to <a href="https://cloud.google.com/blog/products/gcp/kubernetes-best-practices-setting-up-health-checks-with-readiness-and-liveness-probes">Setting Up health checks</a>.</p>
<h3 id="329-section-7-event-driven-autoscaling---keda">3.2.9 Section <em>7</em>. Event-Driven autoscaling - KEDA</h3>
<p>In Kubernetes, scaling replicas is as easy as running:</p>
<pre class="hljs"><code><div>kubectl scale deployments/kubernetes-app --replicas=4
</div></code></pre>
<p>or:</p>
<pre class="hljs"><code><div><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">ReplicaSet</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">3</span>
</div></code></pre>
<p>but, this is a manual process.</p>
<p>The automated way can be performed by using Horizontal Pod Autoscaler. For instance:</p>
<pre class="hljs"><code><div>kubectl autoscale rs myreplicaset --min=2 --max=5 --cpu-percent=80
</div></code></pre>
<p>will create an autoscaler for replication set foo, with target CPU utilization set to 80% and the number of replicas between 2 and 5. Kubernetes 1.6 adds support for making use of custom metrics in the Horizontal Pod Autoscaler.</p>
<p>Instead of using the Horizontal Pod Autoscaler directly, we will use <strong>KEDA</strong> (Kubernetes-based Event-driven Autoscaling), an open source component developed by Microsoft and Red Hat to allow any Kubernetes workload to benefit from the event-driven architecture model. It integrates natively with the Horizontal Pod Autoscaler. <em>KEDA</em> can use <em>Prometheus</em> that will be in charge of getting metrics and other <a href="https://keda.sh/docs/1.5/scalers/">scalers</a> like GCP Pub/sub, Redis or external sources.</p>
<p>KEDA can be deployed as an <a href="https://operatorhub.io/operator/keda">operator</a>. The manifest to autoscale the application can be like:</p>
<pre class="hljs"><code><div><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">keda.k8s.io/v1alpha1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">ScaledObject</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">myapp</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span>
  <span class="hljs-attr">labels:</span>
    <span class="hljs-attr">deploymentName:</span> <span class="hljs-string">myapp</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">scaleTargetRef:</span>
    <span class="hljs-attr">deploymentName:</span> <span class="hljs-string">myapp</span>
  <span class="hljs-attr">pollingInterval:</span> <span class="hljs-number">15</span>
  <span class="hljs-attr">cooldownPeriod:</span>  <span class="hljs-number">30</span>
  <span class="hljs-attr">minReplicaCount:</span> <span class="hljs-number">1</span>
  <span class="hljs-attr">maxReplicaCount:</span> <span class="hljs-number">10</span>
  <span class="hljs-attr">triggers:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">type:</span> <span class="hljs-string">prometheus</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">serverAddress:</span> <span class="hljs-string">http://prometheus:9090</span>
      <span class="hljs-attr">metricName:</span> <span class="hljs-string">access_frequency</span>
      <span class="hljs-attr">threshold:</span> <span class="hljs-string">'3'</span>
      <span class="hljs-attr">query:</span> <span class="hljs-string">sum(rate(http_requests[2m]))</span>
</div></code></pre>
<p>KEDA will poll Prometheus target every fifteen seconds. A minimum of one Pod will be launched (minReplicaCount) and the maximum number of Pods will be up to 10.</p>
<p>Kubernetes can be also autoscaled with <a href="#3210-section-8-microservices-fault-tolerance---istio">Istio Metrics</a>:</p>
<pre class="hljs"><code><div><span class="hljs-string">sum(</span>
    <span class="hljs-string">rate(</span>
      <span class="hljs-string">istio_requests_total{</span>
        <span class="hljs-string">destination_workload="podinfo",</span>
        <span class="hljs-string">destination_workload_namespace="myapp",</span>
        <span class="hljs-string">reporter="destination",</span>
        <span class="hljs-string">response_code!="404"</span>
      <span class="hljs-string">}[1m]</span>
    <span class="hljs-string">)</span>
  <span class="hljs-string">)</span>
</div></code></pre>
<h4 id="3291-kubernetes-cluster-autoscaling">3.2.9.1 Kubernetes Cluster Autoscaling</h4>
<p><a href="https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler">Cluster autoscaler</a> is a tool that automatically adjusts the size of the Kubernetes cluster. You can see the concept <a href="https://cloud.google.com/kubernetes-engine/docs/concepts/cluster-autoscaler">here</a>. To implement with Terraform, just use:</p>
<pre class="hljs"><code><div><span class="hljs-string">node_pool</span> <span class="hljs-string">{</span>
  <span class="hljs-string">name</span>       <span class="hljs-string">=</span> <span class="hljs-string">"default-pool"</span>
  <span class="hljs-string">node_count</span> <span class="hljs-string">=</span> <span class="hljs-number">1</span>

  <span class="hljs-string">autoscaling</span> <span class="hljs-string">{</span>
    <span class="hljs-string">min_node_count</span> <span class="hljs-string">=</span> <span class="hljs-number">1</span>
    <span class="hljs-string">max_node_count</span> <span class="hljs-string">=</span> <span class="hljs-number">3</span>
  <span class="hljs-string">}</span>
</div></code></pre>
<h3 id="3210-section-8-microservices-fault-tolerance---istio">3.2.10 Section <em>8</em>. Microservices Fault Tolerance - Istio</h3>
<p><em><a href="https://istio.io/">Istio</a></em> is a service mesh that provides the fundamentals you need to successfully run a distributed microservice architecture. You can have and automated installed version and upgraded when upgrading <a href="https://cloud.google.com/istio/docs">GKE</a>.</p>
<p><em>Istio</em> adds fault tolerance to the application without any changes to code. Resilience features include timeouts, retries with timeouts, circuit breakers, health checks, AZ-aware load balancing, and systematic fault injection. Basically it can be used to break the circuit if there is no response from the dependent microservices for the given SLA/ETA and provide a mechanism to re-try and graceful shutdown services without any data loss.</p>
<p>Istio not only adds fault tolerance to the equation, also is capable of doing:</p>
<ul>
<li><a href="https://istio.io/latest/docs/tasks/observability/">Telemetry collection</a></li>
<li>Service discovery</li>
<li>Fault Injection</li>
<li>Load balancing</li>
<li><a href="https://istio.io/latest/docs/tasks/security/">TLS termination/origination</a></li>
<li>Request routing</li>
<li><a href="https://istio.io/latest/docs/tasks/traffic-management/">Traffic splitting</a></li>
<li>Canary releasing</li>
<li>Traffic shadowing</li>
<li>Rate limiting</li>
</ul>
<p>As you notice, some of the functionalities of a service mesh like Istio overlaps with some technologies already referred in this document. The important point is using the right technology to give value and stability to the product and make the most of all of them togeter (KEDA and Istio) for scalability. A very good introduction to Istio can be found <a href="https://learn.openshift.com/servicemesh/">here</a>.</p>
<h3 id="3211-section-9-database-and-storage-high-availability">3.2.11 Section <em>9</em>. Database and Storage High availability</h3>
<p>All the data services in the cloud have their own recovery process and a way to ensure data availability. We are going to cover simple concepts here but the most important is the common sense. As we already discuss with logging, it is key to choose which data to save and understand what adds value to our product.</p>
<p>For database queries, it is important to define how long we will keep data alive and when unused data will be archived or moved to a cold storage.</p>
<p>It is important to understand also the scenario for our application. If we need data in different zones, the way we replicate and store the data between regions needs to be defined whithin the application or the Database needs to have the active-active option. It is key to understand what data write/read delay have between regions due to network latency.</p>
<p>This is a typical HA scenario for a Cloud SQL service:</p>
<p><img src="file:///Users/imjoseangel/Documents/source/imjoseangel/microservice-arquitecture/ha-config.png" alt="Cloud SQL"></p>
<p>The same happens for <a href="https://cloud.google.com/memorystore/docs/redis/high-availability">Redis</a> in this case replicating a primary Redis node to a replica node.</p>
<h4 id="32111-backups">3.2.11.1 Backups</h4>
<p>Depending on the technology used it is important to backup the important data and keep the configuration in code as we have been trying to show during the whole Design document.</p>
<h4 id="32112-multicloud">3.2.11.2 Multicloud</h4>
<p>This is a cool topic when referring to resiliency and distributed but not when talking about billing. Having a multicloud option provides the following advantages among others:</p>
<ul>
<li>Improved Multizone</li>
<li>Cloud Provider lock-in Removal</li>
<li>Application and Infrastructure Code Cloud-Agnostic</li>
</ul>
<p>One of the reasons to use K8S is this. You can connect different clouds and choose the best PaaS options for every component as well as improve the system resilience.</p>
<h2 id="4-conclusion">4. Conclusion</h2>
<p>Although there are some big topics not fully covered in this document like:</p>
<ul>
<li>Oauth and RBAC</li>
<li>POD and Container Security</li>
<li>API Gateway</li>
<li>Networking</li>
<li>Cache</li>
<li>Self-Service for Infrastructure</li>
<li>Cost Management</li>
</ul>
<p>And some others that could be improved, hopefully this document would be a good startup point for ideas and learnings. I think it could be a good base to understand different technologies and ways of working.</p>
<p>Please don't hesitate to contact me if you find any issue or incorrect idea or any other queries.</p>
<h2 id="5-project-strategy">5. Project Strategy</h2>
<h3 id="51-key-milestones-and-deliverables">5.1 Key Milestones and Deliverables</h3>
<table>
<thead>
<tr>
<th>Event / Milestone</th>
<th>Deliverable</th>
<th>Timing</th>
</tr>
</thead>
<tbody>
<tr>
<td>Arquitecture Design</td>
<td>Design Document</td>
<td>Sprint 1</td>
</tr>
</tbody>
</table>

</body>
</html>
